window.serverUnreachable=function(){$(document).trigger("server-unreachable")};var pcode="P".charCodeAt(0),globalStreams=function(){var e={};e.onlineStream=Bacon.fromBinder(function(n){var o=!0;function e(e,t){n(o=!1)}function t(e,t){0==o&&n(o=!0)}return $(document).on("server-unreachable",e),$(document).on("server-ack",t),window.addEventListener("online",t),window.addEventListener("offline",e),function(){$(document).off("server-unreachable",e),$(document).off("server-ack",t),window.removeEventListener("online",t),window.removeEventListener("offline",e)}}),e.webStorageSupportedStream=Bacon.fromBinder(function(n){function e(e,t){n(!1)}return $(document).on("no-local-storage",e),function(){$(document).off("no-local-storage",e)}}),e.spaceKeyStream=$(window).asEventStream("keydown").filter(function(e){return 32==e.keyCode&&1!=e.ctrlKey&&1!=e.metaKey&&1!=e.shiftKey&&1!=e.altKey&&!isMenuOpen()}).debounceImmediate(200),e.arrowsStream=$(window).asEventStream("keydown").filter(function(e){return(37==e.keyCode||38==e.keyCode||39==e.keyCode||40==e.keyCode)&&1!=e.ctrlKey&&1!=e.metaKey&&1!=e.shiftKey&&1!=e.altKey}).map(function(e){return e.keyCode}),e.numberShorcutStream=$(window).asEventStream("keydown").filter(function(e){return 48<=e.keyCode&&e.keyCode<=57&&1!=e.ctrlKey&&1!=e.metaKey&&1!=e.shiftKey&&1!=e.altKey}).map(function(e){return e.keyCode}),e.dataItemModifyStream=new Bacon.Bus,e.dataItemDeleteStream=new Bacon.Bus,e.deleteShapeStream=new Bacon.Bus,e.closeLibraryStram=new Bacon.Bus,e.undoStackStream=new Bacon.Bus,e.redoStackStream=new Bacon.Bus,e.shapeLinkStream=new Bacon.Bus,e.shapeResizeStream=new Bacon.Bus,e.newChatMessageStream=new Bacon.Bus,e.clearChatStateStream=new Bacon.Bus,e.currentUserStream=new Bacon.Bus,e.websocketMouseStream=new Bacon.Bus,e.usersStream=new Bacon.Bus,e.notifyStream=new Bacon.Bus,e.shapeContextStream=new Bacon.Bus,e.newShapeStream=new Bacon.Bus,e.mapViewStateStream=new Bacon.Bus,e.contextMenuStream=new Bacon.Bus,e.showFreehandLineWeightStream=new Bacon.Bus,e.updatedFreehandLineWeightStream=new Bacon.Bus,e.onboardingStream=new Bacon.Bus,e.reloadBoardUsersStream=new Bacon.Bus,e.boardScaledStream=new Bacon.Bus,e.scaleRestoreStream=new Bacon.Bus,e.reduxStream=new Bacon.Bus,e.userMessagePropsStream=new Bacon.Bus,e.userMessageEventStream=new Bacon.Bus,e.selectionStream=new Bacon.Bus,e.navigationUpdatedStream=new Bacon.Bus;var n="N".charCodeAt(0);e.newBoardShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=e.keyCode==n&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&e.altKey;return t&&e.preventDefault(),t});var o="E".charCodeAt(0);e.editPresentationShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=e.keyCode==o&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&e.altKey;return t&&e.preventDefault(),t});var r="I".charCodeAt(0);e.boardInfoShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=e.keyCode==r&&(e.ctrlKey||e.metaKey)&&!e.shiftKey&&!e.altKey&&!gwtIsEditorOpen();return t&&e.preventDefault(),t});e.enterCmdShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=13==e.keyCode&&(e.ctrlKey||e.metaKey)&&!e.shiftKey&&!e.altKey;return t&&e.preventDefault(),t}),e.startPresentationShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=e.keyCode==pcode&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&e.altKey;return t&&e.preventDefault(),t}),e.presentationCommandStream=new Bacon.Bus,e.addSlideStream=new Bacon.Bus,e.quitPresentationStream=new Bacon.Bus,e.editPresentationStream=new Bacon.Bus,e.slideCreatedStream=new Bacon.Bus,e.scaleResetStream=new Bacon.Bus,e.boardSaveStatusChangedStream=new Bacon.Bus,e.reloadTagsStream=new Bacon.Bus,e.backgroundMoveStream=new Bacon.Bus,e.closeEditorStream=new Bacon.Bus,e.shapeAddedStream=new Bacon.Bus,e.hideContextMenuStream=new Bacon.Bus,e.trySendQueueStream=new Bacon.Bus,e.cometSessionStream=new Bacon.Bus,e.mobileLayoutStream=new Bacon.Bus,e.animateStream=new Bacon.Bus;var a="Z".charCodeAt(0);e.birdsEyeShortcutDownStream=$(window).asEventStream("keydown").filter(function(e){var t=!(e.keyCode!=a||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||window.isMenuOpen()||gwtIsEditorOpen());return t&&e.preventDefault(),t});var i="C".charCodeAt(0);e.commentShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=!(e.keyCode!=i||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||gwtIsEditorOpen()||window.isMenuOpen());return t&&e.preventDefault(),t}),e.birdsEyeShortcutUpStream=$(window).asEventStream("keyup").filter(function(e){var t=!(e.keyCode!=a||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||window.isMenuOpen()||gwtIsEditorOpen());return t&&e.preventDefault(),t});var c="+".charCodeAt(0);e.zoomInShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=!(e.keyCode!=c&&187!=e.keyCode&&"+"!=e.key||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||window.isMenuOpen()||gwtIsEditorOpen());return t&&e.preventDefault(),e.keyCode!=c&&187!=e.keyCode&&"+"!=e.key||!e.metaKey&&!e.ctrlKey?t:(e.preventDefault(),!0)});var l="-".charCodeAt(0);e.zoomOutShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=!(e.keyCode!=l&&189!=e.keyCode&&"-"!=e.key||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||window.isMenuOpen()||gwtIsEditorOpen());return t&&e.preventDefault(),e.keyCode!=l&&189!=e.keyCode&&"-"!=e.key||!e.metaKey&&!e.ctrlKey?t:(e.preventDefault(),!0)});var s="0".charCodeAt(0);e.zoomResetShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=!(e.keyCode!=s&&"0"!=e.key||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||window.isMenuOpen()||gwtIsEditorOpen());return t&&e.preventDefault(),!(e.keyCode!=s&&"0"!=e.key||!e.metaKey&&!e.ctrlKey)||t});e.editShapeStream=$(window).asEventStream("keydown").filter(function(e){var t=!(113!=e.keyCode&&13!=e.keyCode||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||window.isMenuOpen()||gwtIsEditorOpen());return t&&e.preventDefault(),t}),e.scaleAtStream=new Bacon.Bus,e.surfaceTransformStream=new Bacon.Bus,e.shapeDragStream=new Bacon.Bus,e.applyOperationsStream=new Bacon.Bus,e.freehandStream=new Bacon.Bus;var u=!1;return e.boardLoadedWrapStream={onValue:function(e){var t;return u?e():t=boardLoadedStream.onValue(function(){u=!0,e()}),t}},e.isBoardLoaded=function(){return u},e}(),spaceKeyManager=function(){var t=!1,e={stream:globalStreams.spaceKeyStream};return e.stream.onValue(function(e){_.defer(function(){t=!1})}),e.isHandled=function(){return t},e.handled=function(){t=!0},e}(),globalState=function(){var t={contextMenuOpen:!1,addSlideMode:!1};return globalStreams.contextMenuStream.filter(function(e){return e&&"context-menu-open"===e.type}).onValue(function(e){t.contextMenuOpen=!0}),globalStreams.contextMenuStream.filter(function(e){return e&&"context-menu-hide"===e.type}).onValue(function(e){t.contextMenuOpen=!1}),globalStreams.addSlideStream.onValue(function(){t.addSlideMode=!t.addSlideMode}),t.cancelAddSlideMode=function(){t.addSlideMode&&globalStreams.addSlideStream.push()},t}();window.cancelStream=$(window).asEventStream("keydown").filter(function(e){return 27==e.keyCode&&1!=e.ctrlKey&&1!=e.metaKey&&1!=e.shiftKey&&1!=e.altKey});var doubleDelta=500,lastESC=0;globalStreams.doubleCancelStream=$(window).asEventStream("keydown").filter(function(e){var t=!1;return 27==e.keyCode&&1!=e.ctrlKey&&1!=e.metaKey&&1!=e.shiftKey&&1!=e.altKey&&((e=new Date)-lastESC<=doubleDelta&&(t=!0,e=0),lastESC=e),t}),window.shiftDownStream=$(window).asEventStream("keydown").filter(function(e){return 16==e.keyCode&&1==e.shiftKey&&!isEditorOpen()&&1!=e.ctrlKey&&1!=e.metaKey&&1!=e.altKey}),window.shiftUpStream=$(window).asEventStream("keyup").filter(function(e){return 16==e.keyCode&&!isEditorOpen()&&1!=e.ctrlKey&&1!=e.metaKey&&1!=e.altKey}),window.switchBoardStream=$(window).asEventStream("keydown").filter(function(e){var t=e.keyCode==pcode&&(1==e.ctrlKey||1==e.metaKey)&&1!=e.shiftKey&&1!=e.altKey;return t&&e.preventDefault(),t}),window.boardLoadedStream=Bacon.fromBinder(function(n){function e(e,t){n(t)}return $(document).on("board-loaded",e),function(){$(document).off("board-loaded",e)}}),window.changeFreehandColorStream=Bacon.fromBinder(function(n){function e(e,t){n(t)}return $(document).on("showFreehandColorMenu",e),function(){$(document).off("showFreehandColorMenu",e)}}),window.freehandOnStream=globalStreams.freehandStream.filter(function(e){return e}),window.streamShapeContextMenuShown=Bacon.fromBinder(function(n){function e(e,t){n(t)}return $(document).on("shape-context-menu-shown",e),function(){$(document).off("shape-context-menu-shown",e)}}),window.streamStartTour=Bacon.fromBinder(function(n){function e(e,t){n(t)}return $(document).on("start-tour",e),function(){$(document).off("start-tour",e)}}),window.streamEndTour=Bacon.fromBinder(function(n){function e(e,t){n(t)}return $(document).on("end-tour",e),function(){$(document).off("end-tour",e)}}),window.newLibraryImageStream=Bacon.fromBinder(function(n){function e(e,t){n(t)}return $(document).on("add-img-lib",e),function(){$(document).off("add-img-lib",e)}}),window.deleteLibraryImageStream=Bacon.fromBinder(function(n){function e(e,t){n(t.deleted)}return $(document).on("del-img-lib",e),function(){$(document).off("del-img-lib",e)}}),window.themeChangedStream=new Bacon.Bus,window.mapViewStream=new Bacon.Bus,window.boardReadyStream=Bacon.fromBinder(function(t){function e(e){t(themeName)}return $(document).on("board-rendered",e),function(){$(document).off("board-rendered",e)}});var sketchboard=function(){function s(e,t,n,o){this.p1=e,this.p2=t,this.cp1=n,this.cp2=o}function r(e,t){this.x=e,this.y=t,this.read=function(){var e=arguments[0];return 0<e.length&&e[0]instanceof r?e[0]:0<e.length&&"number"==typeof e[0]?new r(e[0],e[0]):void 0},this.subtract=function(){var e=this.read(arguments);return new r(this.x-e.x,this.y-e.y)},this.toString=function(){return"{ x: "+this.x+", y: "+this.y+" }"},this.add=function(){var e=this.read(arguments);return new r(this.x+e.x,this.y+e.y)},this.multiply=function(){var e=this.read(arguments);return new r(this.x*e.x,this.y*e.y)},this.getLength=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},this.normalize=function(e){void 0===e&&(e=1);var t=this.getLength(),t=0!==t?e/t:0;return new r(this.x*t,this.y*t)},this.negate=function(){return new r(-this.x,-this.y)},this.equals=function(e){return this===e||e&&(this.x===e.x&&this.y===e.y||Array.isArray(e)&&this.x===e[0]&&this.y===e[1])||!1}}var e={};return e.Segment=s,e.Point=r,e.smoothPointsToSegments=function(e){for(var t=[],n=null,o=1;0<=o-1&&o+1<e.length;++o){var r=e[o+1],a=e[o-1],i=r.subtract(e[o]),c=a.subtract(e[o]),l=i.getLength(),r=c.getLength();0<l&&0<r&&(r=(c=i.multiply(r/l).subtract(c).normalize()).negate().multiply(r/3),l=c.multiply(l/3),r=r.add(e[o]),l=l.add(e[o]),1==o?t.push(new s(a,e[o],a,r)):t.push(new s(a,e[o],n,r)),n=l)}return e.length-2<e.length&&t.push(new s(e[e.length-2],e[e.length-1],n,e[e.length-1])),t},e.segmentsToPath=function(e){for(var t="M",n=0;n<e.length;++n)0==n?(t+=e[n].p1.x+","+e[n].p1.y,t+=" C"):t+=" ",t+=e[n].cp1.x+","+e[n].cp1.y+" ",t+=e[n].cp2.x+","+e[n].cp2.y+" ",t+=e[n].p2.x+","+e[n].p2.y;return t},e.toPoints=function(e){for(var t=[],n=0;n<e.length;n+=2){var o=new r(e[n+0],e[n+1]);t.push(o)}return t},e}();"use strict";var mousews=function(){var t=null;function e(){var e=(new Date).getTime();if(!(t&&e<t+5e3)){t=e;e=("https:"==location.protocol?"wss:":"ws:")+"/"+location.hostname+(0<location.port.length?":"+location.port:"")+_config.mousewsURL;console.info("mousews:",e);e=new WebSocket(e);return e.onmessage=function(e){e=JSON.parse(e.data);globalStreams.websocketMouseStream.push(e)},e.onopen=function(){},e.onclose=function(){},e}}var n={},o=!0;return globalStreams.onlineStream.onValue(function(e){o=e}),n.synchronize=function(){try{if(n.ws&&1==n.ws.readyState)return!0;!o||n.ws&&3!=n.ws.readyState||(n.ws=e())}catch(e){}return!1},n.send=function(e){o&&n.ws&&1==n.ws.readyState?(n.ws.send(e),n.userLastActivity=(new Date).getTime()):n.synchronize()},n}(),webStorage=function(){function r(e){return"ls_"+e}var n,t={},o="localStorage",e=function(){try{var e=o in window&&null!==window[o],t="ls___"+Math.round(1e7*Math.random());return e&&((n=window[o]).setItem(t,""),n.removeItem(t)),e}catch(e){return $(document).trigger("no-local-storage"),!1}}();return t.browserSupportsLocalStorage=e,t.set=function(e,t){try{n&&n.setItem(r(e),t)}catch(e){return $(document).trigger("no-local-storage"),!1}return!0},t.get=function(e){var t=null;try{t=n?n.getItem(r(e)):null}catch(e){return $(document).trigger("no-local-storage"),!1}return t},t.isEmpty=function(e){return null==t.get(e)},t.remove=function(e){try{n.removeItem(r(e))}catch(e){return $(document).trigger("no-local-storage"),!1}return!0},t.listen=function(n,o){window.addEventListener("storage",function(e){var t=r(n);e.key===t&&o(e)})},t}(),app=angular.module("myApp",["myApp.controllers","myApp.directives","myApp.factories","myApp.services","myApp.filters","myApp.constants","ngRoute","ngSanitize","ngCookies","ngTouch"]).config(["$locationProvider",function(e){e.hashPrefix("")}]).config(["$routeProvider",function(e){e.when("/account",{templateUrl:"partials/account.html",controller:"AccountController"}),e.when("/profile",{templateUrl:"partials/profile.html",controller:"ProfileController"}),e.when("/integrations",{templateUrl:"partials/integrations.html",controller:"IntegrationsController2"}),e.when("/flowdockint",{templateUrl:"partials/flowdockint.html",controller:"IntegrationsController"}),e.when("/flowdock",{templateUrl:"partials/flowdock.html",controller:"FlowdockController"}),e.when("/slackint",{templateUrl:"partials/slackint.html",controller:"SlackIntController"}),e.when("/hipchatauth",{templateUrl:"partials/hipchatauth.html",controller:"HipChatAuthController"}),e.when("/comments",{templateUrl:"partials/comments.html",controller:"CommentsController"}),e.when("/comments2",{templateUrl:"partials/comments2.html",controller:"Comments2Controller"}),e.when("/plans",{templateUrl:"partials/plans.html",controller:"PlansController"}),e.when("/teams",{templateUrl:"partials/teams.html",controller:"TeamsController"}),e.when("/payment",{templateUrl:"partials/payment.html",controller:"PaymentController"}),e.when("/makepayment",{templateUrl:"partials/makepayment.html",controller:"MakePaymentController"}),e.when("/stripepayment",{templateUrl:"partials/stripepayment.html",controller:"StripePaymentController"}),e.when("/billing",{templateUrl:"partials/billing.html",controller:"BillingController"}),e.when("/managesubscription",{templateUrl:"partials/managesubscription.html",controller:"ManageSubscriptionController"}),e.when("/account-delete",{templateUrl:"partials/account-delete.html",controller:"AccountDeleteController"}),e.when("/login",{templateUrl:"partials/login.html",controller:"LoginController"}),e.when("/feedback",{templateUrl:"partials/feedback.html",controller:"FeedbackController"}),e.when("/contacts",{templateUrl:"partials/contacts.html"}),e.when("/githubhelp",{templateUrl:"partials/githubhelp.html"}),e.when("/exportgithub",{templateUrl:"partials/exportgithub.html",controller:"ExportGitHubController"}),e.when("/error",{templateUrl:"partials/error.html",controller:"ErrorController"}),e.when("/stripe",{templateUrl:"partials/stripecharge.html",controller:"StripeChargeController"}),e.when("/modifyimages",{templateUrl:"partials/modifylibimages.html",controller:"LibImgController"}),e.when("/sendeditemail",{templateUrl:"partials/sendeditemail.html",controller:"SendEditEmailController"}),e.when("/menu",{templateUrl:"partials/menu.html",controller:"MenuController"}),e.when("/createversion",{templateUrl:"partials/createversion.html",controller:"CreateVersionController"}),e.when("/versions",{templateUrl:"partials/versions.html",controller:"VersionsController"}),e.when("/publishongallery",{templateUrl:"partials/publishongallery.html",controller:"PublishOnGalleryController"}),e.when("/boardname",{templateUrl:"partials/boardname.html",controller:"BoardNameController"}),e.when("/background",{templateUrl:"partials/background.html",controller:"BackgroundController"}),e.when("/changepwd",{templateUrl:"partials/changepwd.html",controller:"ChangePasswordController"}),e.when("/apimsg",{templateUrl:"partials/apimsg.html",controller:"APIMessageController"}),e.when("/accept",{templateUrl:"partials/accept.html",controller:"AcceptController"}),e.when("/googledrive",{templateUrl:"partials/googledrive.html",controller:"GoogleDriveController"}),e.when("/hipchat",{templateUrl:"partials/hipchat.html",controller:"HipChatIntController"}),e.when("/hipchatshare",{templateUrl:"partials/hipchatshare.html",controller:"HipChatController"}),e.when("/presentation-edit",{templateUrl:"partials/presentation-edit.html",controller:"PresentationEditController"}),e.when("/boarddetails",{templateUrl:"partials/boardinfo.html",controller:"BoardInfoController"}),e.when("/newteam",{templateUrl:"partials/newteam.html",controller:"NewTeamController"}),e.when("/tutorial",{templateUrl:"partials/tutorial.html",controller:"OnboardingController"})}]);function getScopeById(e){e=document.getElementById(e);return angular.element(e).scope()}function getBoardService(){return"undefined"!=typeof boardService?boardService:(location.reload(),null)}function getAccountService(){return"undefined"!=typeof backend?backend:(location.reload(),null)}"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(e){return this.slice(0,e.length)==e}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return this.slice(-e.length)==e}),window.downloadFile=function(e){var t=getScopeById("ExportCallback");t.$apply(function(){t.downloadFile(e)})},window.downloadFileSocketNotif=function(e){getScopeById("ExportCallback").downloadFileSocketNotif(e)},window.messageSentToFlowdock=function(e){getScopeById("FlowdockController").messageSentToFlowdock(e)},window.showIntro=function(){var e=getScopeById("TourController");e?e.$apply(function(){e.startTour()}):showHelp(!0)},window.showHelp=function(e){var t=getScopeById("GuideController");t&&(e?t.showIntro(!0):t.showIntro(!1),t.$digest())},window.analyticsTrackEvent=function(e,t,n){var o=getScopeById("AnalyticsController");o&&"function"==typeof o.trackEvent&&o.trackEvent(e,t,n)},window.ChatController=function(e,t,n){getScopeById("ChatController")[e](t,n)},window.isMenuOpen=function(){var e=appInjector().get("PopoverService");if(e&&e.isMenuOpen())return!0;e=appInjector().get("AppStateService");return!(!e||!e.isDialogOpen())},window.currentUser=function(){try{return angular.element("body").injector().get("AuthService").currentUser()}catch(e){console.log("ERROR: currentUser retriaval failed")}return""},window.currentBoard=function(){try{return angular.element("body").injector().get("AuthService").currentBoard()}catch(e){console.log("ERROR: currentBoard retriaval failed")}return null},window.currentBoardFullId=function(){try{return angular.element("body").injector().get("Helpers").currentBoardFullId()}catch(e){console.log("ERROR: currentBoardFullId retriaval failed")}return null},window.copyToClipboard=function(){try{return angular.element("body").injector().get("ClipboardService").copyToClipboard(),!0}catch(e){console.log("ERROR: failed to copy data to clipboard: "+e)}return!1},window.pasteFromClipboard=function(){try{angular.element("body").injector().get("ClipboardService").pasteFromClipboard()}catch(e){console.log("ERROR: failed to paste from clipboard: "+e)}return""},window.ngShowLibrarySettings=function(){try{angular.element("body").injector().get("LibrarySettingsService").showLibrarySettings()}catch(e){console.error("ERROR: ngShowLibrarySetttings: "+e)}},window.ngHideLibrarySettings=function(){try{angular.element("body").injector().get("LibrarySettingsService").hideLibrarySettings()}catch(e){console.error("ERROR: ngHideLibrarySettings: "+e)}},window.ngShowImageLibrary=function(){try{angular.element("body").injector().get("ImageLibraryService").showImageLibrary()}catch(e){console.log("ERROR: ngShowImageLibrary: "+e)}},window.ngHideImageLibrary=function(){try{angular.element("body").injector().get("ImageLibraryService").hideImageLibrary()}catch(e){console.log("ERROR: hideImageLibrary: "+e)}},window.ngLoadThumbnails=function(e,t){try{angular.element("body").injector().get("ImageService").loadThumbnails(e,t)}catch(e){console.log("ERROR: failed to load images: "+e)}},window.ngCopyLibraryFileToBoard=function(e){try{getScopeById("FileUploadController").copyLibraryFileToBoard(e,gwtReceiveFileInfo)}catch(e){console.log("ERROR: ngCopyLibraryFileToBoard: "+e)}},window.ngStartUploadFile=function(e,t){try{getScopeById("FileUploadController").startUploadFile(e,t)}catch(e){console.log("ERROR: ngStartUploadFile: "+e)}},window.ngOpenThread=function(e,t){try{getScopeById("board-comments").openThread(e,t)}catch(e){console.log("ERROR: ngOpenThread: "+e)}},window.ngUpdateThreadPosition=function(e,t){try{getScopeById("board-comments").updateThreadPosition(e,t)}catch(e){console.log("ERROR: ngOpenThread: "+e)}},window.removeCookie=function(e){var t=angular.element("[ng-app]");if(void 0!==t)try{t.injector().get("$cookies").remove(e),t.injector().get("$rootScope").$apply()}catch(e){console.log("removeCookie... failed",e)}},window._ng=function(){return angular.element("[ng-app]")},window.waterMark=function(e,t){var n=_ng(),o="";return!n||(n=n.injector().get("AuthService"))&&!n.currentBoard().isPaidBoard()&&(o="<text x='"+(e-15)+"' y='"+(t-15)+"' style='font-weight:Normal; font-size: 16px; text-anchor: end; font-family: Arial; fill: #ccc;'>http://sketchboard.io</text>"),o},window.ngIsLibraryManualShowHide=function(e,t){var n=_ng();if(n){n=n.injector().get("AuthService");if(n&&n.currentUser())return n.currentUser().isLibraryManualShowHide()}return!1},window.saveBoardShape=function(e,t){var n=_ng();n&&n.injector().get("ShapeService").saveBoardShape(e,t)},window.applyCommentOperation=function(e,t){var n=_ng();n&&n.injector().get("CommentsService").applyCommentOperation(e,t)},window.clientReloadUsers=function(e){try{var t=_ng();t&&t.injector().get("BoardUsers").reloadUsers()}catch(e){console.log("clientReloadUsers: ",e)}},window.ngGetBoardPositionFactory=function(){var e=_ng();return e?e.injector().get("BoardPositionFactory"):null},window.ack=function(e,t,n,o){"function"==typeof window.gwtack&&window.gwtack(e,t,n,o)},globalStreams.onboardingStream.filter(function(e){return e.steps_done}).onValue(function(){var e=_ng();!e||(e=e.injector().get("TutorialHelpers"))&&e.showTutorialShare()}),angular.module("myApp.controllers",["texts"]).controller("NotifyController",["$scope","NotifyService",function(e,t){e.state=t.getInfoState()}]).controller("MainController",["$scope","$rootScope","$window","$location","AuthService","PopoverService","Helpers","AppStateService","DeleteLegacyCookies","NotifyService","BoardPositionFactory","Comments2Factory",function(n,e,t,o,r,a,i,c,l,s,u,d){n.currentUser=r.currentUser(),n.currentBoard=r.currentBoard(),n.$watch(r.isLoggedIn,function(e){n.isLoggedIn=e}),n.$watch(r.currentUser,function(e){n.currentUser=e}),n.$watch(r.currentBoard,function(e){n.currentBoard=e}),l.doIt(),n.galleryUrl=_config.galleryUrl,n.goToGallery=function(){backend.getTeamId().then(function(e){n.$apply(function(){t.location.href=e?n.galleryUrl+"/team/"+e+"?s="+n.currentBoardId():n.galleryUrl})})},$("body").on("keyup",function(e){27===e.keyCode&&a.closeAllOpenPopovers()});var r=getApp(),f="webex"==r||"mt"==r,l="mt"==r,r=f&&"host"==function(e){if(0<location.search.length)for(var t=window.location.search.substring(1).split("&"),n=0;n<t.length;n++){var o=t[n].split("=");if(decodeURIComponent(o[0])==e)return decodeURIComponent(o[1])}}("approle");n.appContext={name:f?"webex":null,isWebex:f},n.isWebex=f,n.isMsTeams=l,n.isAppHost=r,n.internalAppContextUrl=function(e){var t="",n=getApp();n&&(t="?app="+n);n=currentBoardFullId();return e+(t=0==t.length?"?name="+n:t+"&name="+n)},n.signup=function(){var e=getApp(),t=currentBoardFullId();e?location.assign("/service/login-embed"+("?app="+e+"&name="+t)):location.assign("/service/signup?name="+t)},f||window.switchBoardStream.onValue(function(e){n.$apply(function(){var e=f?"?app=webex":"";t.location.href="/dashboard/"+n.currentUser.currentTeam.team_id+e})}),n.customerPageUrl=function(e){var t=f?"?app=webex":"";return"/dashboard/"+n.currentUser.currentTeam.team_id+t+"#"+e},globalStreams.commentShortcutStream.onValue(function(){n.$apply(function(){"/comments2"===o.path()?o.path("/"):o.path("/comments2")})}),cancelStream.onValue(function(){globalState.cancelAddSlideMode()}),globalStreams.editPresentationShortcutStream.onValue(function(){n.$apply(function(){"/presentation-edit"===o.path()?o.path("/"):o.path("/presentation-edit").search({})})}),f||globalStreams.boardInfoShortcutStream.onValue(function(){n.$apply(function(){"/boarddetails"===o.path()?o.path("/"):o.path("/boarddetails").search({})})}),f||globalStreams.newBoardShortcutStream.onValue(function(){n.$apply(function(){n.newBoard()})}),cancelStream.onValue(function(){"/comments2"!==o.path()&&n.$apply(function(){o.path("/").search({})})}),n.openBoard=function(e){t.location.href=e},n.billingUrl=function(){return n.currentUser.org_id?"/orgs/"+n.currentUser.org_id+"/bills":"#/billing"},n.newBoard=function(){ReqNewBoard()},n.goto=function(e){o.path(e).search({})},n.currentBoardLink=function(){return o.absUrl().split("#")[0]},n.isLoggedInAndFreeBoard=function(){return n.isLoggedIn&&n.currentBoard.isFree()},n.isLoggedInAndProBoard=function(){return n.isLoggedIn&&n.currentBoard.isPro()},n.isLoggedInAndProAndSharedWithPwBoard=function(){return n.isLoggedIn&&n.currentBoard.isPro()&&n.currentBoard.isPasswordProtected()},n.isLoggedInAndProAndNotSharedWithPwBoard=function(){return n.isLoggedIn&&n.currentBoard.isPro()&&!n.currentBoard.isPasswordProtected()},n.isVersion=function(){return i.isBoardVersion()},n.currentBoardId=function(){return i.currentBoardId()},n.currentBoardVersion=function(){return i.currentBoardVersion()},n.currentBoardFullId=function(){return i.currentBoardFullId()},n.isBlackTheme=function(){return"black"===themeName.value},n.showUpgradeButton=function(){return"mt"!=getApp()&&(!n.currentUser.isAnonymous()&&n.currentBoard.isBoardAccountExpired())},n.isComments=function(){return d.commentThreads},n.upgradeCurrentTeam=function(){_track("upgrade",{category:"board",label:"subscription"}),("mt"==getApp()?globalGoToTeamDashboard:globalupdateCurrentTeam)()},n.upgradeCurrentTeamLink=function(){return("mt"==getApp()?globalDashboardUrl:globalUpgradeCurrentTeamLink)()},n.upgradeTeamToOrgLink=function(){return upgradeTeamToOrgLink()},n.showsUserMessage=!1,globalStreams.userMessagePropsStream.onValue(function(e){n.showsUserMessage=0<e,n.$digest()}),"undefined"!=typeof sketchboard_ng_page&&(n.sketchboardNgPage=sketchboard_ng_page),n.slackLink=function(){return _appState.slackLink},n.showChat2=function(){e.$broadcast("show-chat"),globalStreams.clearChatStateStream.push(),loadChatMessages(-20,20),o.path("/")}}]).controller("MenuController",["$scope","$location","NotifyService",function(t,e,n){t.done=!1,t.close=function(){t.done=!0,e.path("/")},t.print=function(e){!function(){if(t.currentBoard.isPaidBoard())return 1;n.info("Print is not supported on Free plan. You can download board as PNG.")}()||(analyticsTrackEvent("Menu","Print",e),print(e))},t.teamId=function(){}}]).controller("BackgroundController",["$scope","$location",function(e,t){e.done=!1,e.close=function(){e.done=!0,t.path("/")}}]).controller("ChangePasswordController",["$scope","$location",function(e,t){e.done=!1,e.close=function(){e.done=!0,t.path("/")}}]).controller("LoginController",["$scope","$route","$window",function(t,e,n){t.user={},t.signIn=function(){backendLoginService.login(t.user).then(function(e){e&&(n.location.href="/"+t.currentBoard.boardId)})}}]).controller("AnalyticsController",["$scope",function(o){o.trackEvent=function(e,t,n){"undefined"!=typeof ga&&o.currentUser&&(ga("set","UserType",o.currentUser.userType),_trackGA(e,t,n))},"undefined"!=typeof boardLoadedStream&&"undefined"!=typeof initialState&&boardLoadedStream.onValue(function(){_track("updateBoard",{category:"user",label:"visit",userType:initialState.userType})})}]).controller("TourController",["$scope","$document",function(e,t){e.startTour=function(){t.trigger("start-tour"),e.toururl="partials/tour.html"},e.okGotIt=function(){t.trigger("end-tour")}}]).controller("TourSignUpController",["$scope","$document",function(e,t){e.startTour=function(){t.trigger("start-tour"),e.toururl="partials/toursignup.html"},e.okGotIt=function(){t.trigger("end-tour")}}]).controller("OnboardingController",["$scope","$location",function(e,t){function n(){t.path("/").search({})}e.skip=t.search().skip,e.share=t.search().share,e.skip&&globalStreams.onboardingStream.push({skip:!0}),e.skip&&setTimeout(function(){n(),e.$apply()},3e3),e.gotIt=function(){n()}}]).controller("GuideController",["$scope","Helpers","SettingsService",function(t,e,n){var o=["basics1","adddoubleclick","connect-helpers","click-connect","freehand","move-bg","markdown","map-view"],r=["basics1","adddoubleclick","connect-helpers","move-bg","markdown","map-view"],a=0,i="none";function c(e){t.guides=e,a=0,i=t.guides[a]}t.showTitle=!0,$(".tooltip-enabled").tooltip().on("click",function(){$(this).tooltip("hide")});function l(){a<t.guides.length&&(i=t.guides[a],t.$broadcast("step-changed",a)),t.showBasics2()?t.basics2url="partials/guide/basics2.html":t.showColors()?t.colorsurl="partials/guide/colors.html":t.showAccounts()?t.accountsurl="partials/guide/accounts.html":t.showTextDecoration()?t.textdecorationurl="partials/guide/textdecoration.html":t.showShortcuts()?t.shortcutsurl="partials/guide/shortcuts.html":t.learnMore()?t.learnmoreurl="partials/guide/learnmore.html":t.addDoubleClick()?t.adddoubleclick="partials/guide/adddoubleclick.html":t.clickConnect()?t.clickconnect="partials/guide/click-connect.html":t.connectHelpers()?t.connecthelpers="partials/guide/connect-helpers.html":t.mapView()?t.mapview="partials/guide/map-view.html":t.moveBg()?t.movebg="partials/guide/move-bg.html":t.freehandGuide()?t.freehand="partials/guide/freehand.html":t.markdownGuide()&&(t.markdown="partials/guide/markdown.html")}t.showNext=function(){++a,l()},t.done=function(){t.hideGuide(),n.showWelcomeGuideNextTime(!1)},t.showBasics1=function(){return"basics1"==i},t.showBasics2=function(){return"basics2"==i},t.showColors=function(){return"colors"==i},t.showAccounts=function(){return"accounts"==i},t.showTextDecoration=function(){return!1},t.showShortcuts=function(){return"shortcuts"==i},t.learnMore=function(){return"learnmore"==i},t.addDoubleClick=function(){return"adddoubleclick"==i},t.clickConnect=function(){return"click-connect"==i},t.connectHelpers=function(){return"connect-helpers"==i},t.mapView=function(){return"map-view"==i},t.moveBg=function(){return"move-bg"==i},t.freehandGuide=function(){return"freehand"==i},t.markdownGuide=function(){return"markdown"==i},t.showPrev=function(){0<a&&--a,l()},t.prevActiveClass=function(){return 0==a?"disabled":""},t.lastGuide=function(){return!!t.guides&&a>=t.guides.length-1},t.showIntro=function(e){c(e?r:o),a=0,i=t.guides[a],t.show()}}]).controller("ProfileController",["$scope","$timeout","$location","Helpers","AuthService","AvatarUrl",function(n,t,e,o,r,a){n.newprofile={},n.timestamp=(new Date).getTime(),n.hidePage=function(){e.path("/")},n.updateImage=function(){backendProfileService.currentUserAvatarUrl().then(function(e){n.$apply(function(){n.currentUser.avatarUrl=e,n.timestamp=(new Date).getTime()}),_trackGA("UserProfile","Updated","Avatar")})},n.$watch(r.currentUser,function(e){_.extend(n.newprofile,e)}),globalStreams.currentUserStream.onValue(function(e){n.$apply(function(){_.extend(n.newprofile,e)})}),n.updateProfile=function(){backendProfileService.updateProfile(n.newprofile).then(function(e){n.$apply(function(){_.extend(n.currentUser,e),n.updated=!0,t(function(){n.updated=!1},4e3),_trackGA("UserProfile","Updated","BasicInfo")})})},n.avatarUrl=function(){return a.makeUrl(n.currentUser,200)},n.showing=!1,n.showDeleteAccount=function(){n.showing=!n.showing,n.showing&&backend.findMyAllAccountsByPrimaryOwner().then(function(e){e?n.$apply(function(){n.ownedAccounts=e}):n.deleteAccountFailed=!0})},n.deleteAccount=function(){confirm("Delete permanently team(s) and user account?")&&(n.deleting=!0,t(function(){window.location.href="/service/signup"},15e3),backend.deleteAccount().then(function(e){window.location.href="/service/signup"}))},n.profileImgPageLink=function(){var e=getApp(),t="/settings/"+n.currentUser.currentTeam.team_id+"/profile",t="mt"==e?t+"?app="+e+"&from="+n.currentBoard.boardId:t+"?from="+n.currentBoard.boardId;return t+="%23/profile"}}]).controller("FileUploadController",["$rootScope","$scope","$document","errormsg","NotifyService",function(r,a,t,i,c){function l(e,t,n){r.$broadcast("notificationStep",{state:"uploading"});t.processQueue=[{action:"loadImageMetaData",disableExif:!1},{action:"loadImage",fileTypes:/^image\/(gif|jpeg|png)$/,maxFileSize:5e6},{action:"resizeImage",maxWidth:1e3,maxHeight:1e3,orientation:!0},{action:"saveImage"}],t.disableImageResize?t.submit():n(t)}a.clientX=0,a.clientY=0,globalStreams.contextMenuStream.filter(function(e){return e&&"upload"===e.type}).onValue(function(e){a.startUploadFile(e.x,e.y)}),globalStreams.contextMenuStream.filter(function(e){return e&&"add-image"===e.type}).onValue(function(e){a.copyLibraryFileToBoard(e.hash,e.handler)}),a.allowToUpload=function(e){var t=a.currentUser.currentTeam.notExpired;t||(a.$apply(function(){c.info("You need to be logged in and have upgraded team to add images.")}),globalStreams.userMessageEventStream.push(3));for(var n=0;n<e.originalFiles.length;++n){var o=e.originalFiles[n];if("image/gif"!=o.type&&"image/png"!=o.type&&"image/jpeg"!=o.type)return-1}return t?0:-2},a.uploadUrl=function(){return"/upload/image/"+a.currentBoard.boardId},a.fileUploadDropPosition=function(e,t){a.clientX=e,a.clientY=t},a.startUploadFile=function(e,t){function n(){r.$broadcast("notificationStart",{part:"partials/fileupload.html",state:"upload-mobile"})}a.clientX=e,a.clientY=t,a.$$phase?n():a.$apply(function(){n()})},a.fileUploadStart=function(){a.$apply(function(){r.$broadcast("notificationStart",{part:"partials/fileupload.html",state:"uploading",data:{downloads:[]}})})},a.confirmSize=function(e,n,t,o){5e6<t?l(0,n,o):a.$apply(function(){r.$broadcast("notificationStep",{state:"bigfile",callback:{yes:function(){l(0,n,o)},no:function(){var e,t;e=n,t=o,r.$broadcast("notificationStep",{state:"uploading"}),t(e)}}})})},a.fileUploadFailed=function(e){var t=null,n=e.errorThrown.toLowerCase(),o="failed";"unauthorized"==n?t=i.fileTypeNotSupported:"not found"==n||"precondition failed"==n?(t="",o="failed-upgrade-img"):"payload too large"==n&&1==e.files.length&&5e6<e.files[0].size?t=i.tooBigFile:"payload too large"==n&&(t=i.fileUploadFull),a.$apply(function(){r.$broadcast("notificationReady",{state:o,data:{msg:t}})})},a.fileUploaded=function(e){a.$apply(function(){r.$broadcast("notificationReady",{state:"success",data:{},hidesoon:!0}),t.trigger("add-img-lib",e.result),gwtCreateImage(e.result,a.clientX,a.clientY)})},a.copyLibraryFileToBoard=function(e,n){function t(){r.$broadcast("notificationStart",{part:"partials/fileupload.html",state:"copying",data:{downloads:[]}})}a.$$phase?t():a.$apply(function(){t()}),backendProfileService.copyLibraryFileToBoard({hash:e,boardId:a.currentBoard.boardId}).then(function(e){var t;a.$apply(function(){r.$broadcast("notificationReady",{state:"copied",data:{},hidesoon:!0})}),e&&"string"!=typeof e&&"function"==typeof n?n(e):"string"==typeof e&&(t="Sorry, failed to add image.",t=e,a.$apply(function(){c.info(t)}))})}}]).controller("AccountController",["$scope","$location","$filter","$window","Helpers","AuthService","AccountService","accountType","AvatarUrl",function(r,e,o,t,n,a,i,c,l){r.accounts=[],r.defaultAccount="",r.newAccountName={};var s={};(new Date).getTime();r.hideModal=function(){e.path("/")},r.formatPlan=function(e){if(_.isUndefined(e.plan))return e.expired?o("formatFreePlan")():o("formatAccountType")(e.accountType,"");var t,n="";return e.subscription_info&&(n=(t=i.findIntervalByIntervalId(e.subscription_info.interval_id))?" "+t.name:" DEV-"+e.subscription_info.interval_id),o("formatPlan")(e.plan.name+n,"")},r.currentAccounts=function(e){return _.filter(e,function(e){return e.teamId===r.currentUser.currentTeam.team_id})},r.isFreeAccount=function(e){return e.accountType<=1},r.loadAccounts=function(){backend.load().then(function(e){r.$apply(function(){void 0!==e?((new Date).getTime(),r.accounts=e,_.each(r.accounts,function(e){s[e.accountHash]={},e.defaultAccount&&(r.defaultAccount=e.accountHash)})):(r.accounts=[],s={})})})},r.avatarUrl=function(e,t){return l.makeUrl(e,t)},r.accountName=function(e){var t=e.name;return e.expired&&(t+=" -- expired"),t},r.showRename=function(e){r.newAccountName.name=e.name,r.toggle(e)},r.changeAccountName=function(t){var e=_.omit(t,"users");e.name=r.newAccountName.name,backend.changeAccountName(e).then(function(e){r.$apply(function(){e&&(t.name=e,r.newAccountName.name="",r.toggle(t),r.currentUser.currentTeam.team_name=t.name,_trackGA("Account","changeAccountName"))})})},r.timeLeft=function(e){return i.timeLeft(e)},r.showBuyButton=function(e){return!r.isMsTeams&&(!e.org&&(e.iamAdmin&&e.accountType<c.business||!e.validSubscription))},r.showManageSubscription=function(e){return!e.org&&(void 0!==e.plan&&e.iamAdmin||e.validSubscription&&e.iamAdmin)},r.upgradeAccount=function(e){$("#modal").modal("hide"),t.location.href="/settings/"+e.teamId+"/pricing"},r.canRemove=function(e,t){return(0==t.role||2==t.role||3==t.role)&&e.iamAdmin},r.removeAccountUser=function(t,n){confirm("Confirm to delete user from the team")&&backend.removeAccountUser({accountHash:t.accountHash,email:n.email,boardId:r.currentBoard.boardId}).then(function(e){r.$apply(function(){t.users=_.filter(t.users,function(e){return!_.isEqual(e,n)})})})},r.toggle=function(e){n.toggle(r,e.accountHash)},r.newuser=function(e){return s[e]},r.addUser=function(n){s[n].accountHash=n;var e=s[n];e.boardId=r.currentBoard.boardId,r.submitting=!0,backend.addUser(e).then(function(t){r.submitting=!1,_.isObject(t)?(r.$apply(function(){var e=_.find(r.accounts,function(e){return e.accountHash==n});e&&(_.find(e.users,function(e){return e.email==t.email})||e.users.push(t)),s[n]={}}),_trackGA("Account","addUser")):_.isString(t)?r.$apply(function(){r.msg="Please, check the email address, use another email address or contact <a href='mailto:support@sketchboard.io'>support</a> for help."}):r.$apply(function(){var e=getApp();r.msg="mt"==e?"Maximum number of users reached for free plan. <a href='/dashboard' target='_blank' rel='noopener'>Manage your team</a> to add more users.":"Maximum number of users reached. <a href='"+globalUpgradeCurrentTeamLink()+"'>Upgrade plan</a> to add more users."})})},r.stateLeaveTeam=!1,r.showLeaveTeam=function(){r.stateLeaveTeam=!r.stateLeaveTeam},r.leaveTeam=function(){backend.leaveTeam({team_id:r.currentUser.currentTeam.team_id}).then(function(e){e?t.location.href="/":r.failureLeaveTeam=!0,r.$digest()})};var u=[];r.accountRoles=[],r.currentUser.currentTeam.org?r.accountRoles=[{value:"",name:"pick new role",id:-1},{value:"rw",name:"member",id:0},{value:"ro",name:"read-only member",id:2},{value:"admin",name:"admin",id:3}]:r.accountRoles=[{value:"",name:"pick new role",id:-1},{value:"rw",name:"member",id:0},{value:"admin",name:"admin",id:3}];var d=r.accountRoles[0].id;r.selectedRole={id:d},r.showEditRole=function(e,t){return!n.isPrimaryOwner(t)&&(e.iamAdmin&&!r.showEditRoleEditor(t))},r.showEditRoleEditor=function(e){return u[e.email]},r.editRole=function(e){u[e.email]=!0},r.changeRole=function(t){-1!=r.selectedRole.id&&backend.changeAccountUserRole({user:t.email,role:r.selectedRole.id,team_id:r.currentUser.currentTeam.team_id}).then(function(e){e?(r.loadAccounts(),r.failedToUpdateUserRole=!1):r.failedToUpdateUserRole=!0,u[t.email]=!1,r.selectedRole.id=d,r.$digest()})},r.acceptAccount=function(o){backend.acceptAccount(_.omit(o,"users")).then(function(n){r.$apply(function(){var e=_.find(n.users,function(e){return e.email===r.currentUser.email}),t=_.find(o.users,function(e){return e.email===r.currentUser.email});_.extend(t,e)}),_trackGA("Account","acceptAccount")})},r.loadAccounts()}]).controller("IntegrationsController2",["$scope",function(e){}]).controller("IntegrationsController",["$scope","IntegrationsService","Helpers",function(t,n,e){t.accounts=[],t.selectedAccount={name:""},t.newFlow={eventTypes:!0},t.loadAccounts=function(){backendIntegrations.listAccountsWhereUserIsAdmin().then(function(e){t.$apply(function(){void 0!==e&&(t.accounts=e,t.selectedAccount=n.selectAccount(t.accounts),t.selectedAccount&&backendIntegrations.listFlowsForAccount(t.selectedAccount).then(function(e){t.$apply(function(){t.flows=e})}))})})},t.showFlowForm=function(){e.toggle(t,"show-flow-form")},t.addFlow=function(){t.newFlow.accountHash=t.selectedAccount.accountHash,t.newFlow.eventTypes=t.newFlow.eventTypes?1:0,backendIntegrations.addFlowToAccount(t.newFlow).then(function(e){t.$apply(function(){t.newFlow={eventTypes:!0},t.flows=e,t.$broadcast("flow-added")}),_trackGA("Flowdock","AddFlow")})},t.removeFlow=function(e){backendIntegrations.removeFlow(e.flowHash).then(function(e){t.$apply(function(){_.isArray(e)&&(t.flows=e)})})},t.eventTypes=function(e){return 1===e.eventTypes},t.loadAccounts()}]).controller("FlowdockController",["$rootScope","$scope","IntegrationsService","Helpers","NotifyService",function(t,n,e,o,r){function a(){n.flowsend={subject:n.currentBoard.name+" | Sketchboard"}}n.state="",a(),backendIntegrations.listFlowsForBoard(n.currentBoard.boardId).then(function(e){n.$apply(function(){n.flows=e,_.isArray(e)&&0<e.length?(n.flowsend.flowHash=_.first(n.flows).flowHash,n.state="flows-exist"):n.state="no-flows"})}),n.sendToFlow=function(){t.$broadcast("notificationStart",{state:"sending",part:"partials/sendtoflowdock.html"}),n.$broadcast("flow-hide");var e=getBoardSvg();n.flowsend.svg=e.svg,n.flowsend.boardId=e.boardId,flowdockIntegration(n.flowsend),_trackGA("Flowdock","Send")},n.messageSentToFlowdock=function(e){n.$apply(function(){"success"===e?(t.$broadcast("notificationReady",{state:"ready",hidesoonish:!0}),r.info("Board is sent to Flowdock."),_trackGA("Flowdock","Send","Success")):(t.$broadcast("notificationReady",{state:"failed",hidesoonish:!0}),r.info("Sorry, send to Flowdock failed"),_trackGA("Flowdock","Send","Failed")),a()})}}]).controller("HipChatAuthController",["$scope","$window","$timeout",function(t,n,e){t.authorize=function(){t.authorizing||(t.authorizing=!0,e(function(){backendIntegrations.oauthHipChat({board_id:t.currentBoard.boardId}).then(function(e){t.$apply(function(){e?n.location.href=e:(t.authorizing=!1,t.failed=!0)})})},200))}}]).controller("ThreadReplyController",["$scope","CommentPositionFactory",function(e,t){e.$event=t.replyThreadParams.event}]).controller("BoardCommentsController",["$rootScope","$scope","$location","$timeout","Comments2Factory","CommentPositionFactory","BoardUsers","MentionsEditor",function(n,o,e,r,a,t,i,c){o.showBoardComments=!0;var l=globalStreams.animateStream.onValue(function(e){o.showBoardComments="start"!==e,o.$$phase||o.$digest()});o.$on("$destroy",function(){l()}),o.markdown=function(e){return e?marked(e):""},o.resolveThread=function(e,t){a.postUpdateThreadResolveStatus(t.threadid,!0)},o.editMode=!1,o.submitReplyForm=function(e){var t=e.threadid;a.postSaveComment(o.newReply,e,o.selectedShapeIds,function(e){switch(e){case 0:break;case-1:o.infoPlanRestriction=!0;break;case-2:o.failedToCreateComment=!0}o.thread=null,o.selectedShapeIds=null,o.$broadcast("hide-reply-thread."+t),o.$digest()})},o.shouldEnableCommentMenu=function(e,t){return!a.isSystemOrOthersOwn(t)},o.showOptions=function(e,t,n){a.isSystemComment(t)||(o.showCommentOptions=!0,o.currentCommentScope={targetEvent:e,comment:t,thread:n},o.$broadcast("open-comment-options-menu",{targetEvent:e,comment:t,thread:n}))},o.submitUpdateForm=function(e,t){t={commentEdited:o.editedComment,comment:e,thread:t};o.editMode=!1,a.postUpdateComment(t,function(){})},o.cancelEditComment=function(e){o.editMode=!1,o.$broadcast("cancel-edit-"+e.id)},o.cancelReplyThread=function(e){o.$broadcast("hide-reply-thread."+e.threadid)},o.editComment=function(e){o.editMode||(o.editMode=!0,o.editedComment=o.currentCommentScope.comment.comment_text,o.$broadcast("bedit-"+o.currentCommentScope.comment.id))},o.deleteComment=function(){a.removeComment(o.currentCommentScope,function(e){o.$apply(function(){o.failedToDeleteComment=!e})})},o.replyThread=function(e,t){o.thread=t,o.selectedShapeIds=null,o.newReply="",o.$broadcast("breply-"+t.threadid)},o.avatarUrl=function(e){return i.avatarUrl(e)};var s=globalStreams.doubleCancelStream.onValue(function(){a.closeAll(),o.$$phase||o.$digest()});function u(){o.$broadcast("hide.thread")}function d(){o.$apply(function(){o.commentThreads=a.commentThreads,a.commentThreads})}o.$on("$destroy",function(){s()}),o.minimizeThread=function(e){a.openThread(e,!1)},o.openThread=function(e,t){o.editMode=!1,a.openThread(e,!0,t),o.commentThreads=a.commentThreads,o.infoPlanRestriction=!1,o.failedToCreateComment=!1,n.$broadcast("open."+e.threadid),o.$$phase||o.$digest()},o.updateThreadPosition=function(e,t){a.updateThreadPosition(e,t),o.commentThreads=a.commentThreads,o.$$phase||o.$digest()},globalStreams.shapeDragStream.onValue(function(e){"start"===e.type?u():"end"===e.type&&o.$broadcast("show.thread")}),globalStreams.freehandStream.onValue(function(e){e&&u()}),globalStreams.applyOperationsStream.onValue(function(e){globalStreams.isBoardLoaded()}),n.$on("do.comment.create",function(e,t){o.$apply(function(){a.commentThreads,r(function(){o.$broadcast("scrollToBottom."+t.thread.threadid),o.$broadcast("new.comment."+t.thread.threadid,t)})})}),n.$on("do.comment.update",function(e,t){d()}),n.$on("do.comment.update.switch.shapes",function(e,t){d()}),n.$on("do.comment.delete",function(e,t){d()}),n.$on("do.thread.resolve",function(e,t){t.thread.resolved?o.$broadcast("thread.resolved.animate."+t.thread.threadid,{thread:t.thread,done:function(){d()}}):d()});var f=".board-comments";o.$on(a.constCommentsLoaded+f,function(){switch(a.loadResult){case 0:a.commentThreads;break;case-1:o.failedToLoadThreads=!0}o.$digest()}),globalStreams.boardLoadedWrapStream.onValue(function(){a.loadCommentThreads(f)})}]).controller("CreateCommentController",["$rootScope","$scope","Comments2Factory","NotifyService","MentionsEditor",function(n,o,r,a,e){o.newComment="",globalStreams.contextMenuStream.filter(function(e){return e&&"comment.create"===e.type}).onValue(function(e){o.mentionsVisible=!1;var t=r.getSelectedShapes();o.newComment=t.selectedText,o.selectedShapeIds=t.selectedShapeIds,o.thread=null,n.$broadcast("create-comment-thread",e.element),o.$digest()}),o.cancelCreateComment=function(){o.$broadcast("hide-create-thread")};var i=!(o.closeIfEmpty=function(){""==o.newComment&&o.cancelCreateComment()});o.submitComment=function(){function t(){o.newComment="",o.thread=null,o.selectedShapeIds=null,o.$broadcast("hide-create-thread"),i=!1}i||(i=!0,r.postSaveComment(o.newComment,o.thread,o.selectedShapeIds,function(e){switch(i=!1,e){case 0:t();break;case-1:t(),a.info("The free plan includes max 500 comments to be created altogether within the team."),o.$digest();break;default:a.info("Sorry failed to save comment. Note that board needs be owned before it can be commented."),o.$digest()}},function(){o.cancelCreateComment(),i=!1}))}}]).controller("MentionPopupController",["$rootScope","$scope","MentionsEditor",function(e,t,n){var o="open-mentions-selector";n.init(t),t.addMention=function(e){n.addMention(e.mention,o)},t.mentionsHighlightUpdated=function(){t.mentionSelectedIndex=n.getSelectionIndex(),t.$$phase||t.$digest()},e.$on(o,function(){t.mentionSelectedIndex=n.getSelectionIndex(),t.mentions=n.getMentions()})}]).controller("MentionPopupBoardController",["$rootScope","$scope","MentionsEditor",function(e,t,n){var o="open-mentions-selector-1";t.addMention=function(e){n.addMention(e.mention,o)},t.mentionsHighlightUpdated=function(){t.mentionSelectedIndex=n.getSelectionIndex(),t.$$phase||t.$digest()},e.$on(o,function(){t.mentionSelectedIndex=n.getSelectionIndex(),t.mentions=n.getMentions()})}]).controller("Comments2Controller",["$rootScope","$scope","$location","$timeout","$filter","Comments2Factory","BoardUsers","NotifyService","MentionsEditor",function(e,o,t,n,r,a,i,c,l){function s(){o.$apply(function(){o.commentThreads=a.commentThreads})}function u(e){o.$apply(function(){switch(e){case 0:o.$broadcast("do-auto-resize");break;case-1:o.infoPlanRestriction=!0;break;case-2:o.failedToCreateComment=!0}o.newReply=""})}o.getComments=function(e){var t=e.comments;return t=!e.showAll&&3<e.comments.length?e.comments.slice(0,1).concat(e.comments.slice(-3)):t},o.threadLimit=10,o.loadMoreThreads=function(){o.threadLimit+=10},o.showAllComments=function(e){e.showAll=!0},o.createdBy=function(e){return r("createdBy")(e)},o.statusMessage=function(e){return r("statusMessage")(e)},o.simplifyDate=function(e){return r("simplifyDate")(e)},o.avatarUrl=function(e){return i.avatarUrl(e)},o.markdown=function(e){return e?marked(e):""},o.openThreadMenu=function(e,t,n){o.isSystemComment(t)||o.$broadcast("open-thread-menu",{targetEvent:e,comment:t,thread:n})},o.toggleNewComment=function(){o.$broadcast("show-new-comment")},o.setting={showCommentsPublicly:o.currentBoard.isShowCommentsPublicly()},o.toggleCommentSettings=function(){o.$broadcast("show-comment-settings")},o.saveShowCommentsPublicly=function(){o.setting.showCommentsPublicly=!o.setting.showCommentsPublicly,getBoardService().saveShowCommentsPublicly({board_id:o.currentBoard.boardId,team_id:o.currentUser.currentTeam.team_id,show_comments:o.setting.showCommentsPublicly}).then(function(e){console.log("saveShowCommentsPublicly:",e),o.setting.showCommentsPublicly=e.show_comments,o.$digest()})},o.hideComments=function(){t.path("/")},o.showCallback=function(){},o.toggleNewReplyButtons=function(e){e.newReply="",o.$broadcast("toggle-reply-buttons")},o.hideCommentEdit=function(e){o.$broadcast(e)},o.editComment=function(e){o.$broadcast("edit-"+e.comment.id,e)},o.isSystemOrOthersOwn=function(e){return a.isSystemOrOthersOwn(e)},o.isSystemComment=function(e){return a.isSystemComment(e)},o.shouldDisableCommentMenu=function(e,t){return a.shouldDisableCommentMenu(e,t)},o.deleteComment=function(e){a.removeComment(e,function(e){o.$apply(function(){o.failedToDeleteComment=!e})})},o.updateComment=function(e){a.postUpdateComment(e,function(e){o.$apply(function(){o.failedToUpdateComment=!e})})},o.replyThread=function(e){e.forceShowReplies=!0,o.$broadcast(e.threadid)},o.resolveThread=function(e){a.postUpdateThreadResolveStatus(e.threadid,!0)},o.reopenThread=function(e){a.postUpdateThreadResolveStatus(e.threadid,!1)},o.showReplies=function(e){e.forceShowReplies=!e.forceShowReplies},e.$on("do.comment.create",function(e,t){s()}),e.$on("do.comment.update.switch.shapes",function(e,t){s()}),e.$on("do.comment.update",function(e,t){s(),o.$broadcast("hide-comment-edit")}),e.$on("do.comment.delete",function(e,t){s()}),e.$on("do.thread.resolve",function(e,t){s()}),o.replyPlaceholder=function(e){return e.resolved?"Reply re-opens thread...":"Reply..."},o.saveReply=function(e){var t=e.newReply;e.newReply=null,a.postSaveComment(t,e,null,u)},o.saveThreadFirstComment=function(){o.toggleNewComment(),a.postSaveComment(o.newComment,null,o.selectedShapeIds,u),o.selectedShapeIds=null,o.newComment=""},o.topicClicked=function(e,t){t.topic&&e.shape_ids&&0<e.shape_ids.length&&gwtSelectShapes(e.shape_ids,!0,!1)},o.isTopicAndHasShapeIds=function(e,t){return t.topic&&e.shape_ids&&0<e.shape_ids.length},o.topicTitleWithShapes=function(e,t){return o.isTopicAndHasShapeIds(e,t)?"Select commented shapes":""};var d=".comments2";o.$on(a.constCommentsLoaded+d,function(){switch(a.loadResult){case 0:t.search().tid&&""!==t.search().tid?o.replyThreadId=t.search().tid:o.replyThreadId=null,o.commentThreads=a.commentThreads;break;case-1:o.failedToLoadThreads=!0}o.$digest()}),globalStreams.boardLoadedWrapStream.onValue(function(){a.loadCommentThreads(d)}),t.search().create&&n(function(){o.toggleNewComment()}),o.$on("$destroy",function(){o.saveThreadFirstComment(),o.$broadcast("main-comments-closed")})}]).controller("CommentsController",["$scope","elementType",function(r,a){r.firstCommentUser=function(e){return 0<e.length?e[0].cbyd:""},r.reopen=function(t){backendComments.reopen({boardId:r.currentBoard.boardId,threadCid:t.clientId,clientIdentifier:gwtClientIdentifier(),siteId:gwtGetSiteId()}).then(function(e){r.$apply(function(){t.r=null})})},publicBackendComments.boardComments(r.currentBoard.boardId).then(function(o){r.$apply(function(){var e=_.groupBy(o,function(e){return e.elementType}),t=e[a.commentThread],e=e[a.comment],n=_.groupBy(e,function(e){return e.p});r.threads=_.map(t,function(e){return e.comments=n[e.clientId],e})})})}]).controller("LibImgController",["$scope","$location","$document",function(n,e,o){function r(){0==n.images.length&&(n.state=n.states.empty)}function t(){"undefined"!=typeof backendProfileService&&backendProfileService.loadThumbnails({boardId:n.currentBoard.boardId,team_id:n.currentUser.currentTeam.team_id,offset:n.offset,max:n.max}).then(function(e){n.$apply(function(){_.each(e,function(e){n.images.push(e)}),n.state=n.states.loaded,r()})})}n.states={init:1,deleting:2,deleted:3,failed:4,empty:5,loaded:6,notallowed:7},n.state=n.states.init,n.hideModal=function(){e.path("/")},n.images=[],n.offset=0,n.max=40,"undefined"==typeof backendProfileService&&(n.state=n.states.notallowed),t(),n.loadMoreImages=function(){n.offset+=n.max,t()},n.markItem=function(e){e.selected?e.selected=!1:e.selected=!0},n.deleteImages=function(){var t=_.chain(n.images).filter(function(e){return e.selected}).pluck("hash").value();n.state=n.states.deleting,backendProfileService.deleteFromLibrary(t).then(function(e){n.$apply(function(){e?(n.state=n.states.deleted,n.images=_.filter(n.images,function(e){return!e.selected}),r(),o.trigger("del-img-lib",{deleted:t}),"function"==typeof gwtLoadedImagesReset&&gwtLoadedImagesReset(n.images)):n.state=n.states.failed})})}}]).controller("LibrarySettingsController",["$scope","AuthService",function(t,n){function o(e){e.ok?t.$apply(function(){t.currentUser.properties=e.properties,n.currentUser().properties=e.properties,t.settingLibraryAutomaticShowHide=!t.currentUser.isLibraryManualShowHide()}):t.failed=!0}t.settingLibraryAutomaticShowHide=!n.currentUser().isLibraryManualShowHide(),t.getTemplatePath=function(){return"partials/librarysettings.html"},t.saveAutomaticShowHide=function(){t.settingLibraryAutomaticShowHide?backendAuthService.enableLibraryManualShowHide().then(function(e){o(e)}):backendAuthService.disableLibraryManualShowHide().then(function(e){o(e)})}}]).controller("ImageLibraryController",["$scope","$log","NotifyService",function(r,e,a){function t(e){r.modifyClass="img-lib-theme-"+e}function n(){0==r.images.length?r.state=r.states.empty:r.state=r.states.loaded}r.states={init:1,loaded:2,empty:3,notallowed:4},r.state=r.states.init,r.offset=0,r.max=30,r.images=[],r.modifyClass="",r.getProxyName=function(){return"img"},t(themeName.value),newLibraryImageStream.onValue(function(e){r.images.unshift(e),n()}),deleteLibraryImageStream.onValue(function(t){r.images=_.reject(r.images,function(e){return _.contains(t,e.hash)}),r.loadMoreImages()}),themeChangedStream.onValue(function(e){r.$apply(function(){t(e)})}),r.getImageLibraryTemplatePath=function(){return"partials/imagelibrary.html"},r.loadImages=function(){"undefined"!=typeof backendProfileService?backendProfileService.loadThumbnails({boardId:r.currentBoard.boardId,team_id:r.currentUser.currentTeam.team_id,offset:r.offset,max:r.max}).then(function(e){r.$apply(function(){_.each(e,function(e){r.images.push(e)}),r.images=_.uniq(r.images,function(e){return e.hash}),r.state=r.states.loaded,n()})}):r.state=r.states.notallowed},r.loadMoreImages=function(){r.offset+=r.max,r.loadImages()},r.addImage=function(e,n,o){r.currentUser.currentTeam.notExpired&&backendProfileService.copyLibraryFileToBoard({hash:e.hash,boardId:r.currentBoard.boardId}).then(function(e){var t;e&&(angular.isObject(e),1)&&"function"==typeof gwtCreateImage?gwtCreateImage(e,n,o):"string"==typeof e&&(t=e,r.$apply(function(){a.info(t)}))})}}]).controller("SendEditEmailController",["$rootScope","$scope","$location","$timeout","$sce","$sanitize","$compile","BrowserService","NotifyService","sharemenu",function(t,n,e,o,r,a,i,c,l,s){function u(){var e=_.map(n.emails,function(e){var t=e.replace(/\'/g,"\\'");return'<div class="tokens-token" contenteditable="false"><span class="token" email-addr>'+e+'</span><span contenteditable="false" class="icon-cross" ng-click="removeEmail(\''+t+"')\"></span></div>&ensp;"}).join("");n.items=e}function d(e){var t=n.candidateText();(t=void 0!==e?e:t).match("^[^@ \t,]+@([^@ \t,.]+\\.)+[a-z]{2,4}$")?(n.clearText(),n.emails.push(t),u(),n.errormsg=""):""!=t&&(n.errormsg="check your email addresses")}function f(){backendProfileService.sendEmail({emails:n.emails,boardId:n.currentBoard.boardId,customBoardName:n.customBoardName,customMessage:n.customMessage}).then(function(e){n.$apply(function(){e?(n.close(),l.info("Email is sent to "+n.emails.join(", ")+". "+n.additionalMsg),t.$broadcast("")):l.info("Sorry, email sending failed.")})})}function p(e){var t=n.emails;e&&(n.account=e,t=_.filter(n.emails,function(t){return!_.find(e.users,function(e){return e.email==t})})),n.usersNotInAccount=t.join(", "),e.iamAdmin&&0<t.length&&(n.privateboardAndNotInAccount=!0),n.providePassword=!n.currentBoard.isPasswordProtected(),n.currentBoard.isPasswordProtected()||0==t.length?n.currentBoard.isPrivate()&&0==t.length?getBoardService().publishOrPrivate(n.currentBoard).then(function(e){n.$apply(function(){n.currentBoard.visibility=e.visibility,n.additionalMsg=s.sharedWithAccount,f()})}):(n.currentBoard.isPasswordProtected()&&0<t.length&&(n.additionalMsg=s.rememberSharePassword),f()):n.page="share"}n.boardUrl=e.protocol()+"://"+e.host()+"/"+n.currentBoard.boardId,n.emails=[],n.items="",n.errormsg="",n.customMessage="",n.customBoardName=n.currentBoard.name,n.done=!1,n.page="email",n.additionalMsg="",n.accountEmails=[],n.account=null,n.additionalMsg="",c.supportContentEditablePlainText()?n.plainOrEnabled="plaintext-only":n.plainOrEnabled="true",backend.accountUsersForBoard({boardId:n.currentBoard.boardId}).then(function(e){n.account=e,n.$apply(function(){_.each(e.users,function(e){n.accountEmails.push(e.email)})})}),n.removeEmail=function(e){n.emails=_.without(n.emails,e),u()},n.changed=function(e){e=_.chain(e).filter(function(e){return 3!=e.nodeType&&e.firstChild&&e.firstChild.attributes&&e.firstChild.attributes.getNamedItem("email-addr")}).map(function(e){return angular.element(e.firstChild).text()}).value();n.emails=e},n.completeToken=function(e,t){d()},n.completeSelectedToken=function(e){d(e)},n.showPassword=function(){n.page="password",o(function(){n.$broadcast("focus-password")})},n.setPassword=function(){getBoardService().setBoardPassword(n.password).then(function(e){n.$apply(function(){"failed"===e?l.info("Sorry, password change failed"):(_.extend(n.currentBoard,e.boardInfo),l.info(e.msg),n.additionalMsg=s.rememberSharePassword,f())})})},n.addEmailUsers=function(){var e;n.account&&(e=_.map(n.emails,function(e){return{accountHash:n.account.accountHash,email:e}}),backend.addUsersAndChangeBoardVisibility({boardId:n.currentBoard.boardId,users:e}).then(function(e){n.$apply(function(){e?(n.currentBoard.visibility=e.board.visibility,n.additionalMsg=s.sharedWithAccount,f()):l.info("Sorry, couldn't add users to the account.")})}))},cancelStream.onValue(function(){n.$apply(function(){n.close()})}),n.close=function(){n.done=!0,e.path("/"),n.hidePopovers()},n.justSend=function(){f()},n.sendEmail=function(){d();var e=n.candidateText();0<n.emails.length&&0==e.length?(n.errormsg="",p(n.account)):n.errormsg="check your email addresses"}}]).controller("TeamsController",["$scope","$location","$window","Helpers",function(e,t,n,o){e.upgradeCurrentTeam()}]).controller("PlansController",["$scope","$location","$window","$sce","AccountService","Helpers","SubscriptionInfo","PlanFactory",function(e,t,n,o,r,a,i,c){e.upgradeCurrentTeam()}]).controller("PaymentController",["$scope","$location","$window","AccountService","Helpers","TaxFactory","AuthService","SubscriptionInfo","PlanFactory",function(e,t,n,o,r,a,i,c,l){e.upgradeCurrentTeam()}]).controller("StripePaymentController",["$scope","$location","errormsg",function(e,t,n){e.upgradeCurrentTeam()}]).controller("BillingController",["$scope","$location","AccountService",function(t,e,n){backend.getLicenses({team_id:t.currentUser.currentTeam.team_id}).then(function(e){t.$apply(function(){t.licenses=e})}),t.regenerateInvoice=function(e){t.submitting=!0,backend.regenerateInvoice({team_id:t.currentUser.currentTeam.team_id,bill_hash:e.bill_hash}).then(function(e){t.$apply(function(){t.submitting=!1,t.licenses=e})})}}]).controller("AccountDeleteController",["$scope","$location","$window","$timeout",function(t,e,n,o){t.deleteAccount=function(){var e="Delete permanently team and user?";1<t.accounts.length&&(e="Delete team permanently?"),confirm(e)&&(t.deleting=!0,o(function(){n.location.href="/"},15e3),backend.deleteCurrentTeam({team_id:t.currentUser.currentTeam.team_id}).then(function(e){e?n.location.href="/":t.failed=!0,t.$digest()}))},t.accountHash=e.search().account;backend.load().then(function(e){t.$apply(function(){void 0!==e&&(t.accounts=e,backend.getAccount({accountHash:t.accountHash}).then(function(e){t.$apply(function(){e.account&&(t.account=e.account)})}))})})}]).controller("ManageSubscriptionController",["$scope","$location","AccountService","$window",function(t,n,e,o){t.accountHash=n.search().account,t.states={init:0,canceled:1},t.state=t.states.init,backend.getAccount({accountHash:t.accountHash}).then(function(e){t.$apply(function(){e.account&&(t.account=e.account)})}),t.upgradePlan=function(){n.path("/plans").search({account:t.accountHash})},t.updateSubscription=function(){confirm("Confirm to cancel and renew current billing agreement")&&backend.cancelSubscription(t.accountHash).then(function(e){t.$apply(function(){n.path("/payment").search({account:t.accountHash})})})},t.saveCreditCard=function(e){backend.saveCreditCard({account_hash:t.accountHash,stripe_token:e.id,stripe_email:e.email}).then(function(e){0===e.ok?t.creditCardLast4=e.last4:t.failedToChangeCard=!0,t.$digest()})},t.cancelSubscription=function(){confirm("Confirm cancel subscription")&&backend.cancelSubscription(t.accountHash).then(function(e){t.$apply(function(){e&&(t.state=t.states.canceled)})})},t.hasPlan=function(e){return e&&void 0!==e.plan||e&&e.validSubscription}}]).controller("ChatController",["$rootScope","$scope",function(e,o){o.offset=0,o.max=20,o.messages=[];o.applyMessages=function(t,n){o.$apply(function(){var e=angular.fromJson(t);e.messages&&(o.offset=e.offset,o.currentUser&&e.messages.map(function(e){e.user==o.currentUser.email&&(e.user="me")}),o.messages=n?e.messages.concat(o.messages):e.messages)})},o.applyMessage=function(t){o.$apply(function(){var e;20<=o.messages.length&&(e=o.messages.length-20,o.messages.splice(0,e),o.offset=o.offset+e),o.currentUser&&t.user==o.currentUser.email&&(t.user="me"),o.messages.push(angular.fromJson(t))})},o.loadOld=function(){loadPrevMessages(o.offset,20)};var t=!0;globalStreams.onlineStream.onValue(function(e){t=e}),o.sendMessage=function(){t&&(sendChatMessage(o.msg),o.msg="",globalStreams.clearChatStateStream.push())},o.showChat=function(){e.$broadcast("show-chat"),globalStreams.clearChatStateStream.push(),loadChatMessages(-20,20)},o.hideChat=function(){e.$broadcast("hide-chat")}}]).controller("AcceptController",["$scope","$location","$timeout","AcceptAcccountInfo",function(n,e,t,o){n.$watch(o.accounts,function(){n.newTeams=o.accounts});n.accountName=function(e){var t=e.name;return e.expired&&(t+=" -- expired"),t},n.acceptAccount=function(e){backend.acceptAccount(_.omit(e,"users")).then(function(t){n.$apply(function(){"too_many"===t?n.teamFailureTooMany=!0:"expired"===t?n.teamFailureExpired=!0:"unknown"===t?n.teamFailureUnknown=!0:(_.find(n.newTeams,function(e){return e.accountHash===t.accountHash}).userAccepted=!0,backend.load().then(function(t){n.$apply(function(){var e;void 0!==t?(n.accounts=t,(e=_.find(t,function(e){return e.defaultAccount}))&&(n.defaultAccount=e.accountHash)):n.accounts={}})}),n.teamAccepted=!0)})})},n.removeInvitation=function(t){backend.removeInvitation(_.omit(t,"users")).then(function(e){n.$apply(function(){t.invitationRemoved=e})})},n.setDefaultAccount=function(){backend.setDefaultAccount({accountHash:n.defaultAccount}).then(function(e){n.$apply(function(){n.defaultAccountChanged=!0})})}}]).controller("NotificationCenterController",["$scope","$timeout","$sce","$location","AcceptAcccountInfo",function(n,e,t,o,r){var a=!1;function i(){"false"==showWelcome.value&&""!=initialState.notifContent&&n.$broadcast("notificationStart",{state:"show",part:"partials/notificationpart.html",callback:{ok:function(){n.$broadcast("notificationReady",{state:"sending",hidenow:!0}),"undefined"!=typeof backendProfileService&&backendProfileService.readNotification(initialState.notifNmbr).then(function(){n.$apply(function(){})})}},data:{title:initialState.ntitle,msg:initialState.notifContent}})}n.showNotificationCenter=function(){return a},"undefined"!=typeof backend?backend.pendingAccounts().then(function(e){n.$apply(function(){0<e.length?(r.setAccounts(e),o.path("/accept").search({})):i()})}):e(function(){i()}),n.$on("notificationStart",function(e,t){n.notificationPart=t.part,n.notificationState=t.state,n.callback=t.callback,n.data=t.data,a=!0}),n.$on("notificationStep",function(e,t){n.notificationState=t.state,n.callback=t.callback,n.data=t.data}),n.$on("notificationReady",function(e,t){_.has(t,"data")&&t.data&&(n.data=t.data),n.notificationState=t.state,_.has(t,"hidesoonish")&&t.hidesoonish&&n.hidesoonish(),_.has(t,"hidesoon")&&t.hidesoon&&n.hidesoon(),_.has(t,"hidenow")&&t.hidenow&&n.hidenow()}),n.hidenow=function(){a=!1},n.hidesoon=function(){e(function(){a=!1},1e3)},n.hidesoonish=function(){e(function(){a=!1},5e3)},n.closeNotifications=function(){a=!1}}]).controller("APIMessageController",["$scope","$location","apimsg",function(e,t,n){t=t.search().code;t&&(e.code=t)}]).controller("SetupOrganizationController",["$rootScope","$scope","$location","OrganizationInfo","Helpers",function(e,t,n,o,r){t.domain=r.parseEmailDomain(_initialUser.email);var a=(n.search().account_hash?n.search():initialState).account_hash;backend.getUserDefaultAccount().then(function(e){e&&e.account.accountHash!=a&&t.$apply(function(){n.path("/setup-organization").search({account_hash:e.account.accountHash})})}),t.closeModal=function(){n.path("/").search({})},t.companyDomain=function(){backend.createOrganization({account_hash:a}).then(function(e){t.$apply(function(){e?(_.extend(o,e),n.path("/teamsetup").search({account_hash:a})):t.failedToCreateOrganization=!0})})},t.personalDomain=function(){backend.personalDomain({account_hash:a}).then(function(e){t.$apply(function(){_.extend(o,{domain:null}),n.path("/teamsetup").search({account_hash:a})})})}}]).controller("SetupPartOfOrganizationController",["$scope","$location",function(){}]).controller("PublishOnGalleryController",["$rootScope","$scope",function(e,n){function o(){n.showButtons=!1,getBoardService().isManuallyPublished({board_id:n.currentBoard.boardId}).then(function(e){n.$apply(function(){n.showButtons=!0,n.manuallyPublished=e})})}var t="publish-manually";e.$on(t,function(e,t){n.$apply(function(){n.sending=!1,t.data.ok?(n.success=!0,n.galleryUrl=t.data.galleryUrl):n.failed=!0,o()})}),n.publish=function(){n.sending=!0,getBoardService().publishManually({board_id:n.currentBoard.boardId,event:t,sketchboard_ng_page:n.sketchboardNgPage}).then(function(e){e||(n.failed=!0)})};var r="unpublish-manually";e.$on(r,function(e,t){n.$apply(function(){n.sending=!1,t.data.ok?n.successUnpublish=!0:n.failedUnpublish=!0,o()})}),n.unpublish=function(){n.sending=!0,getBoardService().unpublishManually({board_id:n.currentBoard.boardId,event:r,sketchboard_ng_page:n.sketchboardNgPage}).then(function(e){e||(n.failedUnpublish=!0)})},o()}]).controller("BoardNameController",["$scope","$rootScope","$sce","$location","$filter","AuthService","BoardManagerService","Helpers","NotifyService","boardmenu","accountType","sharemenu",function(n,t,e,o,r,a,i,c,l,s,u,d){function f(t){getBoardService().markBoardAsPro(n.currentBoard).then(function(e){n.$apply(function(){_.extend(n.currentBoard,e),l.info(c.format(s.makePrivate,e.accountname)),t&&t()})})}function p(e){a.currentUser().isLoggedIn()&&(a.currentBoard().iAmTheOwner()||a.currentUser().isAccountRoleAdminOrPrimaryOwner()?a.currentBoard().isFree()&&!a.currentUser().isDefaultAccountExpired()?f(function(){o.path("/boardname")}):(0==o.path().length||1==o.path().length&&"/"==o.path())&&o.path("/boardname"):e&&l.info(s.onlyOwnerCanChangeBoardName))}"/boardname"==o.path()&&(n.done=!1,!n.currentUser.isAccountRoleReadOnly()&&(a.currentUser().isAccountRoleAdminOrPrimaryOwner()||a.currentBoard().iAmTheOwner())||(n.done=!0)),a.currentBoard().name!=a.currentBoard().boardId&&(n.boardname=a.currentBoard().name),!initialState.firstTeamLogin&&a.currentBoard().new_board&&p(!1),n.$watch(n.currentBoard,function(){n.visibility=null,n.currentBoard.isAccountVisibility()?n.visibility="team":n.currentBoard.isPrivate()?n.visibility="private":n.currentBoard.isPublic()&&(n.visibility="public"),n.currentBoard.isCreatedBeforeGalleryLaunch()&&(n.viewInGalleryInfo="Public boards created before "+r("date")(_config.galleryLaunchDate,"mediumDate")+" are not show in Sketch Gallery automatically")});var m="make-private";t.$on(m,function(e,t){n.successMakePrivate=t.data.ok,n.$apply(function(){!t.data.ok&&t.data.upgrade?n.upgradeCurrentTeam():t.data.ok&&(n.currentBoard=_.extend(n.currentBoard,t.data.diagram),document.title=t.data.diagram.name+" | Sketchboard",l.info(c.format(d.nowsharedwithaccount,t.accountname)))})}),n.makePrivate=function(){getBoardService().makePrivate({team_id:n.currentUser.currentTeam.team_id,board_id:n.currentBoard.boardId,sketchboard_ng_page:n.sketchboardNgPage,event:m}).then(function(e){e.ok||n.$apply(function(){n.failedMakePrivate=!0,l.info("Sorry, failed to make board private. Please contact support support@sketcboard.io.")})})},n.takeOwnership=function(){getBoardService().takeOwnership({team_id:n.currentUser.currentTeam.team_id,board_id:n.currentBoard.boardId}).then(function(e){0===e.ok?(n.currentBoard.owner=e.owner,o.path("/boardname")):l.info("Sorry, failed to take ownership. Please contact support support@sketcboard.io."),n.$apply()})},n.makePublicBoard=function(){getBoardService().makePublicBoard(n.currentBoard).then(function(e){n.$apply(function(){e&&(n.currentBoard.diagramType=e.diagramType,n.currentBoard.visibility=e.visibility,l.info(c.format(d.nowpublic,e.accountname)),_trackGA("Share","makePublicBoard","ShareOrUnshare"),window.location.reload())})})},n.teamBoard=function(){getBoardService().shareWithAccount(n.currentBoard).then(function(e){n.$apply(function(){n.currentBoard.visibility=e.visibility,l.info(c.format(d.nowsharedwithaccount,e.accountname)),_trackGA("Share","shareWithAccount","ShareOrUnshare"),window.location.reload()})})},n.makePersonal=function(){getBoardService().makePersonal(n.currentBoard).then(function(e){n.$apply(function(){n.currentBoard.visibility=e.visibility,l.info(d.nowprivate)})})},n.saveBoardName=function(){var e=n.boardname||"";getBoardService().saveBoardName({board_id:a.currentBoard().boardId,board_name:e}).then(function(e){n.$apply(function(){_.isString(e)?l.info(e):_.isObject(e)&&(_.extend(n.currentBoard,e),document.title=e.name+" | Sketchboard",t.$broadcast("board-name-saved"))})})},n.renameBoard=function(){a.currentUser().isLoggedIn()?p(!0):l.info(s.renameCondition)},n.markCurrentAsPro=function(){f()},n.freeOwnedSomeoneElse=function(){return e.trustAsHtml(c.format(s.freeOwnedSomeoneElse,n.currentBoard.boardId))},n.freeMyBoard=function(){return e.trustAsHtml(s.freeMyBoard)},n.freeNotOwnedBoard=function(){return e.trustAsHtml(s.freeNotOwnedBoard)},n.freeNotOwnedBoardNotLoggedIn=function(){return e.trustAsHtml(c.format(s.freeNotOwnedBoardNotLoggedIn,n.currentBoard.boardId))}}]).controller("ExportCallback",["$rootScope","$scope","$window",function(t,n,o){n.downloadFileSocketNotif=function(e){t.$apply(function(){0==e.ok?(t.$broadcast("notificationReady",{state:"ready",hidesoon:!0}),_trackGA("Menu","ExportReady",e.exportType),globalStreams.userMessageEventStream.push(2)):(t.$broadcast("notificationReady",{state:"failed",data:{msg:e.msg}}),_trackGA("Menu","ExportFailed",e.exportType))})},n.downloadFile=function(e){e.success?(t.$broadcast("notificationReady",{state:"ready",data:{downloads:[{name:n.currentBoard.name}],exportType:e.exportType},hidesoon:!0}),_trackGA("Menu","ExportReady",e.exportType),function(e){switch(e){case"PNG":case"JPG":case"PDF":case"SVG":case"JSON_CLASS":return 1;default:return}}(e.exportType)&&(n.iframe||(n.iframe=document.createElement("iframe"),n.iframe.style.display="none",document.body.appendChild(n.iframe)),n.iframe.src=e.url)):"string"==typeof e.oauth_url?o.location.href=e.oauth_url:(t.$broadcast("notificationReady",{state:"failed",data:{msg:e.msg,exportType:e.exportType}}),_trackGA("Menu","ExportFailed",e.exportType))}}]).controller("ExportController",["$rootScope","$scope","$window","$location","NotifyService",function(n,o,r,a,t){function i(e){sendToServer(e),a.path("/").search({})}function c(e){return o.currentUser.currentTeam.notExpired||("PNG"==e||("JPG"==e||void globalStreams.userMessageEventStream.push(2)))}function l(){if(!o.currentBoard.noOwner())return o.currentBoard.isPaidBoard()||confirm("Free plan PNG export includes watermark. Remove watermark by upgrading your plan.");t.info("Board needs to be owned before it can be exported")}function s(e,t){e={exportType:e,boardFullId:o.currentBoardFullId()};return t&&(e.client_ids=gwtGetSeletedShapeIds()),e}function u(e){n.$broadcast("notificationStart",{part:"partials/downloadpart.html",state:"generating",data:{downloads:[]}}),a.path("/");var t=[];return t=e?gwtGetSeletedShapeIds():t}function d(e){switch(e.ok){case 0:o.iframe||(o.iframe=document.createElement("iframe"),o.iframe.style.display="none",document.body.appendChild(o.iframe)),o.iframe.src=e.url;break;case-1:n.$apply(function(){t.info("Upgrade to export the board in this format.")});break;default:n.$apply(function(){n.$broadcast("notificationReady",{state:"failed",data:{msg:"Sorry, export failed. Please contact support@sketchboard.io"}}),t.info("Failed to export. Please contact support@sketchboard.io.")})}}o.donwloadPNG=function(e){var t;l()&&(t=u(e),getSocket().then(function(e){exportBackend.exportRequest({board_id:o.currentBoardId(),format:"png",client_ids:t,socket_id:e.id}).then(function(e){d(e),_trackGA("Menu","ExportStarted","PNG")})}))},o.donwloadJPEG=function(e){var t;l()&&(t=u(e),getSocket().then(function(e){exportBackend.exportRequest({board_id:o.currentBoardId(),format:"jpg",client_ids:t,socket_id:e.id}).then(function(e){d(e),_trackGA("Menu","ExportStarted","JPG")})}))},o.downloadSVG=function(e){var t;c("SVG")&&(t=u(e),getSocket().then(function(e){exportBackend.exportRequest({board_id:o.currentBoardId(),format:"svg",client_ids:t,socket_id:e.id}).then(function(e){_trackGA("Menu","ExportStarted","SVG"),d(e)})}))},o.downloadPDF=function(e){var t;c("PDF")&&(t=u(e),getSocket().then(function(e){exportBackend.exportRequest({board_id:o.currentBoardId(),format:"pdf",client_ids:t,socket_id:e.id}).then(function(e){_trackGA("Menu","ExportStarted","PDF"),d(e)})}))},o.exportPDFToGoogleDrive=function(e){c("PDF")&&(n.$broadcast("notificationStart",{part:"partials/downloadpart.html",state:"generating",data:{downloads:[]}}),e=s("PDF2GDRIVE",e),_trackGA("Menu","ExportStarted","PDF2GDRIVE"),i(e))},o.exportPNGToGoogleDrive=function(e){l()&&(n.$broadcast("notificationStart",{part:"partials/downloadpart.html",state:"generating",data:{downloads:[]}}),e=s("PNG2GDRIVE",e),_trackGA("Menu","ExportStarted","PNG2GDRIVE"),i(e))},o.exportSVGToGoogleDrive=function(e){c("SVG")&&(n.$broadcast("notificationStart",{part:"partials/downloadpart.html",state:"generating",data:{downloads:[]}}),e=s("SVG2GDRIVE",e),_trackGA("Menu","ExportStarted","SVG2GDRIVE"),i(e))},o.exportPNGToGitHub=function(e){var t={board_id:o.currentBoard.boardId};e&&(t.client_ids=gwtGetSeletedShapeIds()),exportBackend.oauthGitHub(t).then(function(e){e&&(r.location.href=e)})},o.exportJsonClass=function(){n.$broadcast("notificationStart",{part:"partials/downloadpart.html",state:"generating",data:{downloads:[]}});var e={exportType:"JSON_CLASS"};e.boardFullId=o.currentBoardFullId(),_trackGA("Menu","ExportStarted","JSON_CLASS"),sendToServer(e)},o.exportPlainJSON=function(){exportBackend.exportRequest({board_id:o.currentBoardId(),format:"json",client_ids:gwtGetSeletedShapeIds()}).then(function(e){d(e)})},o.exportJSON=function(){exportBackend.exportRequest({board_id:o.currentBoardId(),format:"json_conn",client_ids:gwtGetSeletedShapeIds()}).then(function(e){d(e)})},o.exportCSV=function(){exportBackend.exportRequest({board_id:o.currentBoardId(),format:"csv_conn",client_ids:gwtGetSeletedShapeIds()}).then(function(e){d(e)})}}]).controller("ExportGitHubController",["$rootScope","$scope","$window",function(t,o,n){o.states={init:0,loaded:1,repository:2},o.state=o.states.init,o.currentPath=[],o.filetypes=["png","svg","pdf"],o.filename=o.currentBoard.name.toLowerCase().replace(/\s/g,"-"),o.description="Modify at https://sketchboard.me/"+o.currentBoard.boardId,_trackGA("Menu","View GitHub Export"),exportBackend.listRepositories({board_id:o.currentBoard.boardId}).then(function(e){o.$apply(function(){0===e.ok?(o.repositories=e.repositories,o.filetype=e.filetype,o.state=o.states.loaded):n.location.href=e.oauthURL})});o.selectRepoTree=function(e){o.currentRepo=e,o.currentBranch=e.branches[0],exportBackend.repoTree({repoName:o.currentRepo.name,branch:o.currentBranch,path:[]}).then(function(e){o.$apply(function(){o.dirs=e,o.state=o.states.repository})})};function r(){exportBackend.repoTree({repoName:o.currentRepo.name,branch:o.currentBranch,path:o.currentPath}).then(function(e){o.$apply(function(){o.dirs=e})})}o.selectRepoBranch=function(e,t){o.currentBranch=t,o.currentPath=[],r()},o.rootPath=function(){o.currentPath=[],r()},o.addPath=function(e){o.currentPath.push(e),r()},o.changePath=function(e,t){var n=t+1;n<o.currentPath.length&&(o.currentPath.splice(n,o.currentPath.length-t),r())},o.changeFileType=function(e){o.filetype=e},o.commitImage=function(){exportBackend.commitImage({boardId:o.currentBoard.boardId,description:o.description,path:{repoName:o.currentRepo.name,branch:o.currentBranch,path:o.currentPath,filename:o.filename,filetype:o.filetype}}).then(function(e){o.$apply(function(){o.$broadcast("closegithub"),t.$broadcast("notificationStart",{part:"partials/downloadpart.html",state:"generating",data:{downloads:[]}}),_trackGA("Menu","GitHub Export",o.filetype)})})}}]).controller("ChangeNameController",["$scope","$compile","BoardManagerService","PopoverService","Helpers",function(t,e,n,o,r){var a="#settingsmenu",i="#change-name-field";t.changeNamePopoverOptions=function(e){return{placement:"top",html:"true",trigger:"manual",title:o.popoverTitle("Change Board Name",a),template:o.popoverTemplate("changeboardename",a)}},t.localChangeBoardName=function(e){angular.element(a).popover("hide")},t.showChangeNamePopover=function(){var e=angular.element(a);e.next("div.popover:visible").length?e.popover("hide"):o.showFormAndFocus("ng-templates/changename.html",e,i,"#ChangeNameController",t,function(e){$(i).val(n.boardNameOrEmpty())})}}]).controller("FeedbackController",["$scope","$location",function(t,e){t.states={init:0,feedbackleft:1,sendingFeedback:2,feedbackFailed:3},t.state=t.states.init,t.hideModal=function(){e.path("/")},t.sendFeedback=function(){t.state=t.states.sendingFeedback,unsubsBackend.leaveFeedback(t.feedback).then(function(e){t.$apply(function(){t.state=e?t.states.feedbackleft:t.states.feedbackFailed})})}}]).controller("ShortcutController",["$scope",function(e){}]).controller("TipFreehandController",["$scope","$compile",function(t,n){window.boardReadyStream.onValue(function(){var e=angular.element("#tip-freehand");e&&(e.attr("tipper",!0),e.attr("data-tip-title","#Tip Freehand"),e.attr("data-tip-content","/partials/tip/freehand.html"),e.attr("data-tip-on-stream","freehandOnStream"),n(e)(t))}),t.freehandDone=function(){"undefined"!=typeof backendAuthService&&backendAuthService.tipFreehandDone(),t.$broadcast("hide-tip")}}]).controller("TipMapViewController",["$scope","$compile",function(t,n){var o=null,o=window.boardReadyStream.onValue(function(){o();var e=angular.element("#tip-map");e&&(e.attr("tipper",!0),e.attr("data-tip-title","#Tip Map View"),e.attr("data-tip-content","/partials/tip/mapview.html"),e.attr("data-tip-on-stream","mapViewStateStream"),n(e)(t))});t.mapViewDone=function(){"undefined"!=typeof backendAuthService&&backendAuthService.tipMapViewDone(),t.$broadcast("hide-tip")}}]).controller("TipSlackController",["$scope","$compile",function(e,t){var n=angular.element("#slack-menu");n&&(n.attr("tipper",!0),n.attr("data-popover-target-selector","#slack-menu"),n.attr("data-tip-title","#Tip Share in Slack Channel"),n.attr("data-tip-content","/partials/tip/slack.html"),n.attr("data-tip-below",!0),n.attr("data-tip-placement","bottom"),t(n)(e)),e.slackDone=function(){"undefined"!=typeof backendAuthService&&(backendAuthService.tipSlackDone(),e.$broadcast("hide-tip"))}}]).controller("TipController",["$scope","$compile","$timeout",function(t,n,o){var r=null,r=globalStreams.shapeAddedStream.onValue(function(){r();var e=window.streamShapeContextMenuShown.onValue(function(){e(),o(function(){var e=angular.element("#tip-shape-added");e.show(),e&&(e.attr("tipper",!0),e.attr("data-popover-target-selector","#tip-shape-added-container"),e.attr("data-tip-title","#Tip Quick Connect"),e.attr("data-tip-content","/partials/tip/quick-connect.html"),e.attr("data-tip-below",!0),e.attr("data-tip-placement","bottom"),n(e)(t))})})});t.quickConnectDone=function(){"undefined"!=typeof backendAuthService&&backendAuthService.tipQuickConnectDone(),t.$broadcast("hide-tip")}}]).controller("ErrorController",["$scope",function(e){}]).controller("UnsubscribeController",["$scope",function(t){t.states={init:0,feedbackleft:1,sendingFeedback:2},t.state=t.states.init,t.unsubscribe=function(){var e=$("[name='email']");e&&(t.state=t.states.sendingFeedback,unsubsBackend.leaveFeedbackNewsletter({email:e[0].value,msg:t.feedback}).then(function(e){t.$apply(function(){"success"===e&&(t.state=t.states.feedbackleft)})}))}}]).controller("CreateVersionController",["$scope","$location","$timeout",function(t,e,n){t.summary="",t.description=null,t.message="",t.sending=!1;t.commitVersion=function(){!t.sending&&0<t.summary.length&&(t.sending=!0,n(function(){getBoardService().commitVersion({boardId:t.currentBoard.boardId,summary:t.summary,description:t.description}).then(function(e){t.$apply(function(){t.message=e})})}))}}]).controller("VersionsController",["$scope","$location","$window","$timeout","boardmenu","Helpers",function(n,e,t,o,r,a){n.versions=[],n.restoreTip=r.restoreTip,n.loadVersions=function(){getBoardService().loadVersions({boardId:n.currentBoardFullId()}).then(function(e){n.$apply(function(){angular.isArray(e)?n.versions=e:n.errormsg="string"==typeof e?e:"Sorry, get versions failed."})})},n.loadMoreVersions=function(){var e=null;0<n.versions.length&&(e=n.versions[n.versions.length-1]),getBoardService().loadVersions({boardId:n.currentBoardFullId(),fromSha:e.sha}).then(function(e){n.$apply(function(){angular.isArray(e)?_.each(e,function(e){n.versions.push(e)}):n.errormsg="string"==typeof e?e:"Sorry, get versions failed."})})},n.loadVersions(),n.textToLines=function(e){return e.split("\n")},n.lineBreak=function(e){return e.join("\n").split("\n")},n.toggleDiff=function(e){n.$broadcast(e)},n.lineStyle=function(e){return e.startsWith("+")?"diff-added":e.startsWith("-")?"diff-removed":""},n.formatVersionUrl=function(e){return"/"+n.currentBoardId()+"-"+e.sha},n.revert=function(t){n.sending||(n.sending=!0,o(function(){var e;e=t,getBoardService().revertToVersion({boardId:n.currentBoardId(),sha:e.sha}).then(function(e){n.$apply(function(){e||NotifyService.info("Sorry, revert failed.")})})}))}}]).controller("VersionController",["$scope","$location","$window","$timeout","boardmenu","Helpers","NotifyService",function(t,e,n,o,r,a,i){t.restoreTip=r.restoreTip,a.isBoardVersion()&&(t.versionsrc="partials/version.html"),t.originalUrl=function(){return t.currentBoardId()},t.revert=function(){t.sending||(t.sending=!0,o(function(){getBoardService().revertToVersion({boardId:t.currentBoardId(),sha:t.currentBoardVersion()}).then(function(e){t.$apply(function(){e?n.location.href="/"+t.currentBoardId():i.info("Sorry, revert failed.")})})}))}}]).controller("OfflineController",["$scope","$http",function(t,e){t.deploying=0,t.reload=function(){window.location.reload()},t.releaseOn=function(e){t.deploying=1,e.release_notes_url&&e.release_notes_url.startsWith("https://sketchboard.io")&&(t.releaseNotes=e.release_notes_url)},t.releaseFalse=function(){t.deploying=0,t.releaseNotes=null},t.hasReleaseNotes=function(){return t.releaseNotes&&0<t.releaseNotes.length}}]).controller("EduController",["$scope",function(e){e.isEduBoard=function(){return void 0!==_appState.eduReturnUrl},e.returnUrl=_appState.eduReturnUrl,e.imageUrl=_appState.appImage,e.appName=_appState.appName}]).controller("GoogleDriveController",["$scope",function(n){n.teamChanged=function(){n.success=!1,backend.setGoogleDriveIntegration({account_hash:n.selectedAccount}).then(function(e){n.success=e,n.$digest()})},"undefined"!=typeof backend&&backend.googleDriveIntegration().then(function(t){var e;0===t.ok?(n.teams=_.sortBy(t.teams,function(e){return e.name}),(e=_.find(n.teams,function(e){return e.teamId==t.int_team_id}))&&(n.selectedAccount=e.accountHash)):n.failed=!0,n.$digest()})}]).controller("HipChatIntController",["$scope","$location","hipchatint",function(t,e,n){function o(){backendIntegrations.isHipChatEnabledForTeam({account_hash:t.selectedAccount,oauth_id:t.configureOAuthId}).then(function(e){t.$apply(function(){switch(e.ok){case 0:t.integrationEnabled=!0;break;case-1:t.integrationEnabled=!1}})})}t.integrationEnabled=!1,t.configureOAuthId=e.search().oauthid,t.accountName=function(e){var t=e.name;return e.expired&&(t+=" -- free plan"),t},t.loadAccounts=function(){backendIntegrations.listCurrentUserAccounts().then(function(e){t.$apply(function(){void 0!==e&&(t.accounts=e,t.selectedAccount=_.find(e,function(e){return e.defaultAccount}).accountHash,o())})})},t.loadAccounts(),t.teamChanged=function(){o()},t.updateHipchat=function(){backendIntegrations.updateHipChatIntegration({account_hash:t.selectedAccount,enabled:t.integrationEnabled,oauth_id:t.configureOAuthId}).then(function(e){t.$apply(function(){switch(e.ok){case 0:t.hipchatSuccess=!0;break;case-1:t.hipchatFailed=!0;break;case-2:t.hipchatFailed=!1,t.hipchatAlreadyUsedFailure=!0}t.integrationEnabled?t.successMessage=n.enabledText:t.successMessage=n.disabledText})})}}]).controller("SlackIntController",["$scope",function(t){t.slashCmdToken="",t.dataNotOk=function(){return 0==t.slashCmdToken.length||(0==t.slashCmdToken.indexOf("****")||(0==t.webhookURL.length||0==t.webhookURL.indexOf("****")))},t.accountName=function(e){var t=e.name;return e.expired&&(t+=" -- free plan"),t},t.loadAccounts=function(){backendIntegrations.listAccountsWhereUserIsAdmin().then(function(e){t.$apply(function(){void 0!==e&&(t.accounts=e,t.selectedAccount=_.find(e,function(e){return e.defaultAccount}).accountHash,backendIntegrations.isSlackEnabledForTeam({account_hash:t.selectedAccount}).then(function(e){t.$broadcast("slackint-initialized"),0===e.ok&&(t.slashCmdToken=e.slack_slash_token,t.webhookURL=e.webhook_url,t.integrationUrl=e.integration_url,t.integrationEnabled=!0)}))})})},t.loadAccounts(),t.saveSlackToken=function(){t.dataNotOk()||backendIntegrations.saveSlackSlashToken({account_hash:t.selectedAccount,slack_slash_token:t.slashCmdToken,webhook_url:t.webhookURL}).then(function(e){t.$apply(function(){switch(e.ok){case 0:t.success=!0,t.integrationUrl=e.integration_url,t.integrationEnabled=!0;break;case-1:t.failed=!1,t.failedNotAdmin=!0;break;case-2:t.failed=!0}})})},t.regenerateIntegrationUrl=function(){confirm("Are you sure you want to regenerate this integration URL?")&&backendIntegrations.regenerateIntegrationUrl({account_hash:t.selectedAccount}).then(function(e){t.$apply(function(){switch(e.ok){case 0:t.integrationUrl=e.integration_url;break;case-1:t.failedRegenerate=!1,t.failedRegerateNotAdmin=!0;break;case-2:t.failedRegenerate=!0}})})}}]).controller("HipChatController",["$rootScope","$scope","$location",function(e,n,t){n.message="","undefined"!=typeof backendAuthService?backendAuthService.hipchatRoom(n.currentBoard.boardId).then(function(e){e.ok&&n.$apply(function(){n.roomName=e.roomName})}):t.path("/").search({}),e.$on("hipchat-uploaded",function(e,t){n.$apply(function(){n.sending=!1,n.message="",t.data?n.hipchatSuccess=!0:n.hipchatFailed=!0})}),n.shareInHipChat=function(){var e;n.sending||(n.sending=!0,e={board_id:n.currentBoard.boardId,msg:n.message,event:"hipchat-uploaded",sketchboard_ng_page:n.sketchboardNgPage},0<gwtGetSeletedShapeIds().length&&(e.client_ids=gwtGetSeletedShapeIds()),backendIntegrations.sendToHipChat(e).then(function(e){e||n.$apply(function(){n.failed=!0,n.sending=!1})}))}}]).controller("BoardInfoController",["$scope","$location","$window","NotifyService","AuthService",function(n,e,t,o,r){function a(){getBoardService().findAllTagsByDiagram({board_id:n.currentBoardId()}).then(function(e){n.$apply(function(){n.tags=e})})}n.tags=[],r.currentUser().isLoggedIn()||e.path("/").search({}),n.styleOpposite=function(){return n.currentBoard.isSketchMode()?"Corporate":"Awesome"},n.switchStyle=function(){gwtToggleSketchMode()},n.close=function(){e.path("/").search({})},n.copyCurrentAsNew=function(){getBoardService().copyCurrentAsNew({board_id:n.currentBoard.boardId,team_id:n.currentUser.currentTeam.team_id}).then(function(e){e&&(t.location.href="/"+e)})},n.saveAsTemplate=function(){t.location.href="/dashboard/"+n.currentUser.currentTeam.team_id+"#/template/save/"+n.currentBoard.boardId},n.canIDeleteBoard=function(e){return!n.currentUser.isAccountRoleReadOnly()&&(!!e.iAmTheOwner()||!!n.currentUser.isAccountRoleAdminOrPrimaryOwner())},n.deleteBoard=function(t){confirm("Delete board **"+t.name+"** permanently?\nThis cannot be undone!")&&getBoardService().deleteBoard({board_id:t.boardId}).then(function(e){e&&(e=n.boards.indexOf(t),n.boards.splice(e,1)),n.$digest()})},n.searchTags=function(e,t){getBoardService().searchTags({board_id:n.currentBoardId(),query:e}).then(function(e){t(_.map(e,function(e){return e.name}))})},n.select=function(e){n.addTag(e)},n.addTag=function(e){0<e.length&&getBoardService().addTag({tag:e,board_id:n.currentBoardId()}).then(function(e){n.$apply(function(){switch(e){case 0:n.$broadcast("clear-input"),a();break;case-1:o.info("Max 2 tags can be created on free plan.");break;case-2:o.info("Sorry, tag creation failed")}})})},n.openTag=function(t){getBoardService().findBoardsByTag({board_id:n.currentBoardId(),tag:t.name.replace(/ /g,"-")}).then(function(e){n.$apply(function(){t.boards=e})})},n.deleteTag=function(e){getBoardService().deleteTag({board_id:n.currentBoardId(),tag:e.name.replace(/ /g,"-")}).then(function(e){e&&a()})},a()}]).controller("NewTeamController",["$scope","$location","$window",function(t,e,n){t.close=function(){e.path("/").search({})},t.saving=!1,t.saveNewTeam=function(){t.saving||(t.saving=!0,backend.saveNewTeam({name:t.teamName,currentTeam:t.currentUser.currentTeam.team_id}).then(function(e){switch(e.ok){case 0:n.location.href="/";break;case-1:t.failureExpiredAccount=!0;break;default:t.failed=!0}t.saving=!1,t.$digest()}))},t.isOrganizationSubscription=function(){return t.currentUser.currentTeam.notExpired&&null!=t.currentUser.currentTeam.org},t.okToCreateNewTeam=function(){return t.isOrganizationSubscription()&&t.currentUser.isAccountRoleAdminOrPrimaryOwner()}}]).controller("PresentationEditController",["$scope","$location","$sce","NotifyService",function(l,t,n,e){if(!l.currentBoard.isPro())return t.path("/").search({}),void e.info("Presentation is available only on private boards.");function s(){l.slides=_.sortBy(l.slides,function(e){return e.data.order})}function o(){var e;t.path("presentation-edit")&&(e=gwtGetSlides(92,70,!0),l.slides=e.slides,s())}l.slides=[];try{o()}catch(e){boardLoadedStream.onValue(function(){l.$apply(function(){o()})})}globalStreams.addSlideStream.onValue(function(){l.$$phase?l.addSlideMode=globalState.addSlideMode:l.$apply(function(){l.addSlideMode=globalState.addSlideMode})}),globalStreams.slideCreatedStream.onValue(function(){l.$apply(function(){o()})}),l.startPresentation=function(){t.path("/presentation").search({})},l.slideId=function(e){return e.clientId},l.changeSlideOrder=function(t,n){var e,o,r,a,i=_.findIndex(l.slides,function(e){return n===e.clientId}),c=_.findIndex(l.slides,function(e){return t===e.clientId});c!=i&&0<=c&&0<=i&&(e=l.slides[c],o=l.slides[i],0==i?e.data.order=o.data.order/2:0<=i-1&&i<c?(r=l.slides[i].data.order,a=l.slides[i-1].data.order,e.data.order=a+(r-a)/2):c<i&&i+1<l.slides.length?e.data.order=l.slides[i+1].data.order/2:e.data.order=o.data.order+1,gwtUpdateSlide(e)),s()},l.createSlide=function(){globalStreams.addSlideStream.push()},l.svgContainerStyle=function(e){e.width,e.height;return""};var r=[];l.addSlide=function(e){r.push(e)},l.getSlides=function(){return r},l.slideSvg=function(e){return n.trustAsHtml(e.svg)},l.quitEdit=function(){t.path("/").search({}),globalState.cancelAddSlideMode()}}]),angular.module("myApp.directives",[]).directive("whenScrolled",function(){return function(e,t,n){var o=t[0];t.bind("scroll",function(){o.scrollTop+o.offsetHeight>=o.scrollHeight&&e.$apply(n.whenScrolled)})}}).directive("whenScrolledUp",function(){return function(e,t,n){var o=t[0];t.bind("scroll",function(){0==o.scrollTop&&e.$apply(n.whenScrolledUp)})}}).directive("closeOnEsc",function(){return function(e,t,n){$("body").on("keyup",function(e){27===e.keyCode&&((e=t.find("input"))&&e.blur(),t.hide())})}}).directive("escHandler",function(){return function(t,n,o){$("body").on("keyup",function(e){27===e.keyCode&&((e=n.find("input"))&&e.blur(),t.$apply(o.escHandler))})}}).directive("clickOutsideHandler",function(){return function(t,n,o){Hammer(document).on("tap",function(e){n.is(e.target)||0!==n.has(e.target).length||((e=n.find("input"))&&e.blur(),t.$eval(o.clickOutsideHandler))})}}).directive("closeClickOutside",function(){return function(e,t,n){$("body").on("mousedown",function(e){t.is(e.target)||0!==t.has(e.target).length||((e=t.find("input"))&&e.blur(),t.fadeOut(250))})}}).directive("capitalize",function(){return function(e,t,n){t.text((t=t.text()).substring(0,1).toUpperCase()+t.substring(1))}}).directive("toggle",["$timeout",function(o){return function(t,n,e){e.$observe("toggle",function(e){t.$on("event:toggle:"+e,function(){n.slideToggle(),o(function(){n.find("input[type=text]").focus()})})})}}]).directive("toggleOn",["$timeout",function(o){return function(e,t,n){e.$on(n.toggleOn,function(){t.is(":visible")?t.hide():t.hasClass("btn")?t.css({display:"inline-block"}):(t.toggle(),o(function(){t.find("input[type=text]").focus()}))})}}]).directive("slideOnStateVisible",function(){return function(e,n,t){e.$watch("state.visible",function(e,t){t!=e&&n.slideToggle()})}}).directive("popover",["Helpers",function(r){return function(e,t,n){var o=r.format('<div class="popover {}"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',"help-popover");e.hidePopovers=function(){t.popover("hide")},t.popover({html:!0,content:n.popover,placement:n.popoverPlacement,trigger:"hover",container:"body",template:o})}}]).directive("tooltip",function(){return function(e,t,n){function o(){var e={title:n.tooltip,placement:n.tooltipPlacement};n.tooltipEmbedContainer?e.container=!1:e.container="body",n.tooltipHtml&&(e.html=!0),t.tooltip(e),t.on("mousedown",function(){t.tooltip("hide")})}isTouch()||(n.tooltipDelay?_.delay(o,parseInt(n.tooltipDelay)):o())}}).directive("enterKey",function(){return function(t,e,n){e.on("keydown",function(e){13==e.which&&(t.$apply(function(){t[n.enterKey]()}),e.preventDefault())})}}).directive("enterCmd",function(){return function(t,e,n){e.on("keydown",function(e){13==e.which&&(e.ctrlKey||e.metaKey)&&(t.$apply(n.enterCmd),e.preventDefault())})}}).directive("enterSubmit",function(){return function(t,e,n){e.on("keydown keypress",function(e){13!==e.which||e.shiftKey||e.altKey||(e.preventDefault(),t.$apply(n.enterSubmit))})}}).directive("addMentionsSymbol",["$rootScope",function(o){return function(e,t,n){t.on("click",function(){o.$broadcast(n.addMentionsSymbol)})}}]).directive("mentionsTextarea",["$rootScope","MentionsEditor",function(r,a){return function(n,t,o){n.getSelectionStart=function(){return t.prop("selectionStart")},n.getSelectionEnd=function(){return t.prop("selectionEnd")},n.textAreaValue=function(){return t[0].value},n.setTextareaValue=function(e){var t=o.ngModel.split(".");!function e(t,n,o,r){if(o!=n.length-1)return e(t[n[o]],n,++o,r);t[n[o]]=r}(n,t,0,e)},n.getTextareaElement=function(){return t[0]},n.textAreaFocus=function(){t[0].focus()},n.setCursorPosition=function(e){t.prop("selectionStart",e),t.prop("selectionEnd",e)},n.$on(o.threadid+"-atsign",function(){n.addMentionSymbolOnEditor(n,n)}),n.$on(o.mentionsTextarea,function(){a.addMentionSymbol(n,o.mentionsEvent)}),t.on("click keyup",function(e){a.handleEvent(e,n,o.mentionsEvent)}),t.on("keydown",function(e){!a.shouldHandleKeyDown(e.which)||38!=e.which&&40!=e.which&&13!=e.which||(e.preventDefault(),a.handleSelectKey(n,e.which),r.$broadcast("mentions-highlight-updated"))})}}]).directive("keyUp",function(){return function(t,e,n){e.on("keyup",function(e){13!=e.which&&32!=e.which&&37!=e.which&&38!=e.which&&39!=e.which&&40!=e.which&&t.$apply(function(){t[n.keyUp](e)})})}}).directive("keyUpDelayed",function(){return function(e,t,n){var o=_.debounce(function(){e.$apply(n.keyUpDelayed)},1e3);t.on("keyup",function(e){13!=e.which&&32!=e.which&&37!=e.which&&38!=e.which&&39!=e.which&&40!=e.which&&o()})}}).directive("enterKeyGetsVal",function(){return function(t,n,o){n.on("keydown",function(e){13==e.which&&(t[o.enterKeyGetsVal](n.val()),e.preventDefault())})}}).directive("sbPopover",function(){return function(e,t,n){t.ngInclude=n.sbPopover,e.$on("show-"+n.sbPopover,function(){})}}).directive("focusOnEvent",["$timeout",function(o){return function(e,n,t){e.$on(t.focusOnEvent,function(e,t){touchEnabledDevice?n.focus():o(function(){var e;n.focus(),t&&("number"==typeof(e=n[0]).selectionStart?e.selectionStart=e.selectionEnd=e.value.length:void 0!==e.createTextRange&&(e.focus(),(e=e.createTextRange()).collapse(!1),e.select()))})})}}]).directive("focus",["$timeout",function(o){return function(e,t,n){o(function(){t.focus()})}}]).directive("select",["$timeout",function(o){return function(e,t,n){o(function(){t.select()})}}]).directive("focusOn",["$timeout",function(o){return function(e,t,n){uiutils.isMobile()||e.$on(n.focusOn,function(){o(function(){t.focus()})})}}]).directive("ngTokenizer",["$compile",function(e){return function(t,n,e){var o=/([^\#-~| |!])/g;function r(){return n.contents().filter(function(){return 3===this.nodeType}).text().trim().replace(/&/g,"&amp;").replace(o,function(e){return"&#"+e.charCodeAt(0)+";"}).replace(/</g,"&lt;").replace(/>/g,"&gt;")}t.candidateText=r,t.clearText=function(){n.contents().filter(function(){return 3===this.nodeType}).remove()},n.on("blur keyup change",function(){t.$apply(function(){n.contents().filter("br").remove(),t[e.ngTokenizer](n.contents())})}),n.on("keydown",function(e){13!=e.which?188===e.which&&(t.$apply(function(){t.completeToken(n,e)}),e.preventDefault()):e.preventDefault()}),e.typeahead&&t.$watch(t.accountEmails,function(){n.typeahead({source:t.accountEmails,text:r,selected:function(e){e&&t.$apply(function(){t.completeSelectedToken(e)})}})}),n.on("blur",function(e){t.$apply(function(){t.completeToken(n,e)})})}}]).directive("customHtml",["$compile","$timeout",function(r,a){return function(t,o,n){t.$watch(n.customHtml,function(){var e=t[n.customHtml];o.html(r(e)(t)),""!=e&&o.append("&ensp;"),a(function(){var e,t,n;(e=o).focus(),void 0!==window.getSelection&&void 0!==document.createRange?((n=document.createRange()).selectNodeContents(e[0]),n.collapse(!1),(t=window.getSelection()).removeAllRanges(),t.addRange(n)):void 0!==document.body.createTextRange&&((n=document.body.createTextRange()).moveToElementText(e[0]),n.collapse(!1),n.select())})})}}]).directive("modalShowOnLoad",["$location","$rootScope",function(o,r){return function(t,n,e){n.on("hidden",function(e){e.target!=n[0]||r.$$phase||t.$apply(function(){o.path("/").search({})})}),t.$on("$routeChangeStart",function(){n.modal("hide")}),t.$on("$routeChangeSuccess",function(){n.modal("show")})}}]).directive("modalCloseOn",["$location","$rootScope",function(o,e){return function(e,t,n){e.$on(n.modalCloseOn,function(){t.modal("hide"),o.path("/").search({})})}}]).directive("pageClose",["$location",function(o){return function(e,t,n){Hammer(t[0]).on("tap",function(){o.path("/").search({}),e.$apply()})}}]).directive("scrollToBottomOn",["$timeout",function(r){return function(t,e,n){var o=e[0];n.$observe("scrollToBottomOn",function(e){t.$on(e,function(){r(function(){$(o).animate({scrollTop:o.scrollHeight},1e3)})})})}}]).directive("profileImgUpload",function(){return function(o,r,e){r.fileupload({dataType:"json",autoUpload:!1,maxNumberOfFiles:1,limitConcurrentUploads:1,dropZone:"nodrop"==e.profileImgUpload?null:$(document),pasteZone:"nodrop"==e.profileImgUpload?null:$(document),acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,maxFileSize:5e6,processQueue:[{action:"loadImageMetaData",disableExif:!1},{action:"loadImage",fileTypes:/^image\/(gif|jpeg|png)$/,maxFileSize:5e6},{action:"resizeImage",maxWidth:7200,maxHeight:7200,orientation:!0,forceResize:!0},{action:"saveImage"}],disableImageResize:/Android(?!.*Chrome)|Opera/.test(window.navigator&&navigator.userAgent),add:function(e,t){function n(e){function t(){e.process(function(){return r.fileupload("process",e)}).done(function(){e.submit()})}try{t()}catch(e){r.fileupload(),t()}}switch(o.allowToUpload(t)){case 0:o.fileUploadStart(),t.url=o.uploadUrl(),r.fileupload(),0<t.files.length&&3e5<t.files[0].size?(t.autoUpload=!1,o.confirmSize(r,t,t.files[0].size,n)):n(t);break;case-1:o.fileUploadStart(),o.fileUploadFailed({errorThrown:"unauthorized"})}}}).on("fileuploaddrop",function(e,t){var n;e.originalEvent&&(n=null,e.originalEvent.delegatedEvent&&e.originalEvent.delegatedEvent.originalEvent?n=e.originalEvent.delegatedEvent.originalEvent:e.originalEvent.originalEvent&&(n=e.originalEvent.originalEvent),n&&o.fileUploadDropPosition(n.clientX,n.clientY))}).on("fileuploadfail",function(e,t){o.fileUploadFailed(t)}).on("fileuploaddone",function(e,t){o.fileUploaded(t)})}}).directive("librarySettings",["DirectiveHelpers",function(o){return function(e,t,n){o.injectLibrary(e,t,n,{showOn:"show-library-settings",hideOn:"hide-library-settings",hideAlt1:"library-hide",showAlt1:"library-show-library_settings"},e.getTemplatePath())}}]).directive("imageLibrary",["DirectiveHelpers",function(o){return function(e,t,n){o.injectLibrary(e,t,n,{showOn:"show-image-library",hideOn:"hide-image-library",hideAlt1:"library-hide",showAlt1:"library-show-images"},e.getImageLibraryTemplatePath(),function(){e.loadImages()})}}]).directive("shapePath",function(){}).directive("slideDrag",["$document","ImageProxyService",function(p,m){return function(a,o,e){var t=0,n=0,r=0,i={left:0,top:0},c=!1,l=null;function s(e){null!=e&&e.find(".pe-highlight-normal").removeClass("pe-highlight")}function u(e){e.preventDefault(),e.gesture.touches[0].screenX,r=e.gesture.touches[0].screenY-n,function(e){for(var t=a.getSlides(),n=0;n<t.length;++n){var o,r=t[n];r==l||(o=uiutils.getPosition(r)).top<e&&e<o.top+o.height&&(r.find(".pe-highlight-normal").addClass("pe-highlight"),s(l),l=r)}}(e.gesture.touches[0].clientY),o.css("visibility","hidden"),c||(e=m.getProxy("slide"),uiutils.applyPos(i,0,r,e))}function d(){var e=m.getProxy("slide");uiutils.getPosition(e);m.getProxy("slide").css("display","none")}function f(e){Hammer(p[0]).off("drag",u),Hammer(p[0]).off("dragend",f),function(){for(var e=a.getSlides(),t=0;t<e.length;++t)s(e[t])}(),o.css("visibility","visible");var t=o.data("slide-id"),n=l.data("slide-id");a.changeSlideOrder(t,n),d()}a.addSlide(o),Hammer(o[0]).on("dragstart",function(e){e.preventDefault(),c=!1,r=0,n=e.gesture.touches[0].screenY-r,(e=m.getProxy("slide")).html(o.find("svg").clone()),e.css("display","inline-block"),i=uiutils.getPosition(o),uiutils.applyPos(i,t,n,e),Hammer(p[0]).on("drag",u),Hammer(p[0]).on("dragend",f)})}}]).directive("dragProxy",["$document","ImageProxyService",function(h,g){return function(o,t,e){var n=0,r=0,a=0,i=0,c={left:0,top:0};t.css({cursor:"pointer"});function l(e){var t=e[0];return $.extend({},"function"==typeof t.getBoundingClientRect?t.getBoundingClientRect():{width:t.offsetWidth,height:t.offsetHeight},e.offset())}var s=function(e,t){g.getProxy(o.getProxyName()).css({top:c.top+t+"px",left:c.left+e+"px"})},e=angular.element(e.dragProxy),u=l(e),d=!1;function f(){g.getProxy(o.getProxyName()).css("display","none")}function p(e){e.preventDefault(),a=e.gesture.touches[0].clientX-n,i=e.gesture.touches[0].clientY-r,d||s(a,i)}function m(e){var t,n;Hammer(h[0]).off("drag",p),Hammer(h[0]).off("dragend",m),t=g.getProxy(o.getProxyName()),n=l(t),t=n.left>u.left,d||t||(t=o.img,"img"==o.getProxyName()?o.addImage(t,n.left,n.top):o.addShape(o.shape,n.left,n.top)),f()}cancelStream.onValue(function(){d=!0,f()}),Hammer(t[0]).on("dragstart",function(e){e.preventDefault(),d=!1,i=a=0,n=e.gesture.touches[0].clientX-a,r=e.gesture.touches[0].clientY-i,e=g.getProxy(o.getProxyName()),"img"==o.getProxyName()?e.attr("src",t.attr("src")):e.html(t.find("svg").clone()),e.css("display","inline-block"),c=l(t),s(n,r),Hammer(h[0]).on("drag",p),Hammer(h[0]).on("dragend",m)})}}]).directive("guide",function(){return function(e,t,n){e.hideGuide=function(){t.hide()},e.show=function(){t.show()},angular.element(document).on("touchstart",function(e){t.hide()})}}).directive("feedback",["$document",function(e){return function(e,t,n){isTouch()||t.css({display:"block"})}}]).directive("showPreview",function(){return function(e,t,n){t.on("mouseover",function(){t.tooltip({html:!0,placement:"bottom",title:'<img src="'+n.showPreview+'" width="300px">'})})}}).directive("showBoardDetails",["$filter",function(a){return function(e,t,n){var o=a("date")(n.updatedat,"'Updated: 'dd.MM.yyyy 'at' HH.mm"),r="";"true"===n.public?r="Public board":"true"!==n.public&&"true"===n.private?r="Private board":"true"!==n.public&&"true"!==n.private&&(r="Team board");t.tooltip({html:!0,placement:"top",title:"<div style='text-align:left;'>"+o+"</div><div style='text-align:left;'>Owner: "+n.owner+"</div><div style='text-align:left;'>Visibility: "+r+"</div><div style='text-align:left;overflow:hidden;'>Team: "+(25<n.team.length?_.first(n.team,25).join("")+"...":n.team)+"</div>"})}}]).directive("stripeCheckout",["$compile",function(t){return function(e,n,o){var r=angular.element('<form action="{{stripeAction()}}" class="hidden" method="POST"><input type="hidden" name="boardid" value="{{currentBoard.boardId}}"><input type="hidden" name="account" value="{{currentAccountHash()}}"></form>');$("body").append(r),t(r)(e),$.getScript("https://checkout.stripe.com/checkout.js",function(){var t=StripeCheckout.configure({key:o.key,image:"/static/images/sketchoboardme-logo-128x128.png",allowRememberMe:!1,token:function(e,t){r.append('<input type="hidden" name="stripeToken" value="'+e.id+'">'),r.append('<input type="hidden" name="stripeEmail" value="'+e.email+'">'),r.submit()}});n.on("click",function(e){_trackGA("send","event","open-stripe","payment","subscribe"),t.open({name:"Sketchboard",description:"Sketchboard Subscription",panelLabel:o.panelLabel}),e.preventDefault()})})}}]).directive("stripeUpdateCreditCard",["$compile",function(e){return function(n,e,o){$.getScript("https://checkout.stripe.com/checkout.js",function(){var t=StripeCheckout.configure({key:o.key,image:"https://s3-eu-west-1.amazonaws.com/pub.sketchboard.io/img/logo-144x144.png",allowRememberMe:!1,token:function(e,t){n.saveCreditCard(e)}});e.on("click",function(e){_track("addcc",{category:"popup",label:"subscription"}),t.open({name:"Sketchboard",description:o.panelTitle,panelLabel:o.panelLabel,zipCode:!0,billingAddress:!0}),e.preventDefault()})})}}]).directive("conversionSubs",["$window",function(r){return function(o,e,t){o.goog_report_conversion_subs=function(e){!function(){var e=r;e.google_conversion_id=1012845830,e.google_conversion_label="98jgCOi81mYQhpr74gM",e.google_conversion_value=1;try{e.google_conversion_value=o.priceInfo.total}catch(e){console.error("Failed to set price info")}e.google_conversion_currency="USD",e.google_remarketing_only=!1}(),r.google_conversion_format="3";var t=new Object;t.onload_callback=function(){void 0!==e&&(r.location=e)};var n=r.google_trackConversion;"function"==typeof n&&n(t)},$.getScript("//www.googleadservices.com/pagead/conversion_async.js",function(){console.log("conversion configured")})}}]).directive("freeNotOwnedBoard",["$compile","boardmenu",function(o,r){return function(e,t,n){t.append(angular.element(r.freeNotOwnedBoard)),o(t.contents())(e)}}]).directive("onClickSelect",function(){return function(e,t,n){t.click(function(){t.select()})}}).directive("closeDialog",["$rootScope","$location",function(a,i){return function(e,t,n){function o(){e.done=!0,i.path("/")}function r(){e.$apply(function(){o()})}a.$on(n.closeDialog,function(){o()}),cancelStream.onValue(function(){r()}),t.on("click",function(){r()})}}]).directive("delayPlay",[function(){return function(t,n,e){function o(e){setTimeout(function(){try{n[0].play(),t.$digest()}catch(e){}},e)}n[0].addEventListener("ended",function(){o(3e3)}),o(2e3)}}]).directive("step",function(){return function(e,n,o){0==parseInt(o.step)&&n.addClass("step-focus"),e.$on("step-changed",function(e,t){t==parseInt(o.step)?n.addClass("step-focus"):n.removeClass("step-focus")})}}).directive("tour",function(){return function(e,t,n){var o=window.streamStartTour.onValue(function(){o(),t.addClass("overlay"),t.removeClass("hide")}),r=window.streamEndTour.onValue(function(){r(),t.addClass("hide")})}}).directive("copyText",["$timeout",function(a){return function(t,n,o){var e=new ClipboardJS(n[0]);e.on("error",function(e){Hammer(n[0]).on("tap",function(){window.prompt("1. Copy to clipboard: Cmd/Ctrl+C, Enter.\n2. Send link e.g. by email.",t.currentBoardLink())})});var r=o.title;n.tooltip({trigger:"hover",placement:"top",container:"body"}),e.on("success",function(e){n.attr("data-original-title",o.copiedHint),n.tooltip("show"),a(function(){n.tooltip("hide"),n.attr("data-original-title",r)},4500)})}}]).directive("copyTextSimple",["NotifyService",function(r){return function(t,n,o){var e=new ClipboardJS(n[0]);e.on("error",function(e){Hammer(n[0]).on("tap",function(){window.prompt("1. Copy to clipboard: Cmd/Ctrl+C, Enter.\n2. Send link e.g. by email.",t.currentBoardLink())})}),e.on("success",function(e){t.$apply(function(){r.info(o.copiedHint)})})}}]).directive("tourTip",["$timeout",function(a){return function(o,e,t){function n(e,t){var n=2500;t&&(n=1e3*parseInt(t)),a(function(){o.$broadcast("tour-tip"+(e+1))},n)}var r=parseInt(t.tourTip);1==r?n(r,t.tourDelay):e.hide(),o.$on("tour-tip"+t.tourTip,function(){e.show(),n(r,t.tourDelay)})}}]).directive("tipper",["$compile","$http",function(f,p){return function(t,e,n){var o=angular.element('<div class="tip-pulse pulse"></div>'),r=$.extend({},e.offset(),{height:e[0].offsetHeight});$("body").append(o);var a=r.left-+o[0].offsetWidth/2,i=r.top-+o[0].offsetHeight/2;n.tipBelow&&(a=r.left-o[0].offsetWidth/2,i=r.top+r.height-+o[0].offsetHeight/2),o.css({top:i,left:a});var c=e,l="top";function s(){var e=angular.element("#TipContainer").find(".popover-content");f(e)(t)}n.popoverTargetSelector&&(c=angular.element(n.popoverTargetSelector)),n.tipPlacement&&(l=n.tipPlacement);var u,d=null;Hammer(o[0]).on("tap",function(){d?(c.popover("show"),s()):p.get(n.tipContent).then(function(e){d=c.popover({html:!0,title:n.tipTitle,content:e.data,placement:l,trigger:"manual",container:"#TipContainer"}),c.popover("show"),s()})}),t.$on("hide-tip",function(){c.popover("hide"),o.hide()}),n.tipOnStream&&(o.hide(),u=(_.has(globalStreams,n.tipOnStream)?globalStreams:window)[n.tipOnStream].onValue(function(){o.show(),u()})),f(o)(t)}}]).directive("offline",function(){return function(t,n,e){function o(){"function"==typeof window.isMaintenance?window.isMaintenance().then(function(e){t.releaseOn(e),t.$digest(),n.show()}).catch(function(e){e&&e.responseText&&console.error("offline directive:",e.responseText),t.releaseFalse(),n.show()}):n.show()}globalStreams.onlineStream.onValue(function(e){e?n.hide():o()}),globalStreams.cometSessionStream.onValue(function(e){e?n.hide():o()})}}).directive("localStorageNotSupported",function(){return function(e,t,n){webStorage.browserSupportsLocalStorage&&t.hide(),globalStreams.webStorageSupportedStream.onValue(function(e){e?t.hide():t.show()})}}).directive("localStorageSupported",function(){return function(e,t,n){webStorage.browserSupportsLocalStorage&&t.show(),globalStreams.webStorageSupportedStream.onValue(function(e){e?t.show():t.hide()})}}).directive("showOn",["$rootScope",function(o){return function(e,t,n){o.$on(n.showOn,function(){t.show()})}}]).directive("hideOn",["$rootScope",function(o){return function(e,t,n){o.$on(n.hideOn,function(){t.hide()})}}]).directive("onFocus",["$rootScope",function(o){return function(e,t,n){t.on("focus",function(){e.$apply(function(){o.$broadcast(n.onFocus)})})}}]).directive("scrollToBottomOn",["$rootScope","$timeout",function(o,r){return function(e,t,n){o.$on(n.scrollToBottomOn,function(){r(function(){t.each(function(e){this.scrollTop=this.scrollHeight})},100)})}}]).directive("hideOnOffline",function(){return function(e,t,n){globalStreams.onlineStream.onValue(function(e){e?t.show():t.hide()})}}).directive("hideIfReadOnly",function(){return function(e,t,n){function o(){t.css({display:"none"})}var r=[],a=globalStreams.boardLoadedWrapStream.onValue(function(){gwtIsEditable()||o()});a&&r.push(a),r.push(globalStreams.onlineStream.onValue(function(e){gwtIsEditable()&&e?t.css({display:"none"}):o()})),t.on("$destroy",function(){_.each(r,function(e){e()})})}}).directive("doubleCancelHides",["$rootScope","$location",function(e,o){return function(e,t,n){globalStreams.doubleCancelStream.onValue(function(){o.path("/")})}}]).directive("hideClickedOutside",["$location","$timeout","Helpers",function(a,e,i){return function(t,n,o){function r(e){a.path()===o.hideClickedOutside&&i.isOutsideElement(n,e.target)&&(t.$apply(function(){a.path("/").search({})}),Hammer(document).off("tap",r))}e(function(){t.$on("$routeChangeStart",function(){Hammer(document).off("tap",r)}),Hammer(document).on("tap",r)})}}]).directive("onHoverChangePath",["$location",function(o){return function(e,t,n){t.on("mouseover",function(){e.$apply(function(){o.path("/"+n.onHoverChangePath)})})}}]).directive("tapOpen",["$location","$timeout",function(o,r){return function(e,t,n){Hammer(t[0]).on("tap",function(){e.$apply(function(){r(function(){n.tapOpenUri?location.href=n.tapOpen:o.path(n.tapOpen)})})})}}]).directive("chatButton",function(){return function(t,n,e){globalStreams.clearChatStateStream.onValue(function(){function e(){n.removeClass("highlight");var e=n.find("i");e.removeClass("main-ico-chat-white"),e.addClass("main-ico-chat")}t.$$phase?e():t.$apply(function(){e()})}),globalStreams.newChatMessageStream.onValue(function(){t.$apply(function(){n.addClass("highlight");var e=n.find("i");e.addClass("main-ico-chat-white"),e.removeClass("main-ico-chat")})})}}).directive("commentsButton",["$rootScope","$location","URLParser","Comments2Factory",function(a,i,c,l){return function(e,o,t){function r(){o.removeClass("highlight"),o.find("i").removeClass("main-ico2-comments-white")}a.$on("comment.create",function(e,t){var n;"/comments2"!==i.path()&&t.site_id!==gwtGetSiteId()&&(o.addClass("highlight"),o.find("i").addClass("main-ico2-comments-white"),l.findThread(t.thread.threadid).open?r():n=a.$on("open."+t.thread.threadid,function(){r(),n()}))}),a.$on("$locationChangeStart",function(e,t,n){"#/comments2"===c.parseURL(t).hash&&r()})}}]).directive("miniThread",["$rootScope","$location","Comments2Factory","URLParser",function(r,e,a,i){return function(e,n,t){function o(){n.removeClass("highlight");var e=n.find("i");e.addClass("menu-icon-comments"),e.removeClass("context-icon2-comment")}e.$on("new.comment."+e.thread.threadid,function(e,t){a.findThread(t.thread.threadid).open||t.site_id===gwtGetSiteId()||(n.addClass("highlight"),(t=n.find("i")).removeClass("menu-icon-comments"),t.addClass("context-icon2-comment"))}),r.$on("open."+e.thread.threadid,function(){o()}),r.$on("$locationChangeStart",function(e,t,n){"#/comments2"===i.parseURL(t).hash&&o()})}}]).directive("menuShortcut",["Helpers",function(r){return function(e,t,n){var o="",o=r.isMac()?"⌘"+n.menuShortcut:"Ctrl+"+n.menuShortcut;t.append('<span class="menu-shortcut">'+o+"</span>")}}]).directive("tooltipShortcut",["Helpers",function(r){return function(e,t,n){var o="",o=r.isMac()?" | ⌘"+n.tooltipShortcut:" | Ctrl+"+n.tooltipShortcut,n=t.attr("title");t.attr("title",n+o)}}]).directive("openOrClose",["$location",function(o){return function(e,t,n){try{Hammer(t[0]).on("tap",function(){e.$apply(function(){o.path()===n.openOrClose?o.path("/").search({}):o.path(n.openOrClose)})})}catch(e){log.error(e)}}}]).directive("d3",function(){return function(e,t,n){$.cachedScript("/static/resources-static-1/js/app/lib/d3.js").done(function(e,t){console.log("d3 loaded...")})}}).directive("slideSvg",function(){return function(e,t,n){try{var o;_.isArray(e.slide)?_.isArray(e.slide)&&(t.empty(),t.append(e.slide[0].documentElement)):(o=(new DOMParser).parseFromString(e.slide.svg,"image/svg+xml"),e.slide.documentElement=o.documentElement,t.empty(),t.append(e.slide.documentElement))}catch(e){}}}).directive("documentState",[function(){return function(t,n,e){var o,r=!0;globalStreams.boardSaveStatusChangedStream.onValue(function(){r&&n.css("display","inline-block"),o&&clearTimeout(o),r=!1;var e=gwtIsSaved();e&&(t.savingTakesTime=!1),t.$$phase?t.setStatus(e):(t.setStatus(e),t.$digest()),o=setTimeout(function(){t.savingTakesTime=!0,t.$digest()},5e3)})}}]).directive("tagEditor",["$timeout",function(e){return function(n,o,r){var a=angular.element('<input class="tag-editor" placeholder="+ Tag" maxlength="50">');n.$on("clear-input",function(){a.val("")}),a.on("keydown",function(e){var t;13!=e.which||(t=o.find(".typeahead"))&&!t.is(":visible")&&(n.$apply(function(){n[r.tagEditor](a.val())}),e.preventDefault())}),e(function(){a.focus()}),a.typeahead({source:n.searchTags,text:function(){return a.val()},matcher:function(e){return e},selected:function(e){e&&n.$apply(function(){a.val(e),n.select(e)})}}),o.append(a)}}]).directive("showCaretMenu",["Helpers",function(c){return function(e,t,n){var o=!1,r=t.find(".caret-menu"),a=null;function i(e){c.isOutsideElement(r,e.target)&&(a&&a.hide(),r.hide(),o=!1,Hammer(document).off("tap",i))}r&&r.hide(),t.on("mouseover",function(){r.show()}),t.on("mouseout",function(){o||r.hide()}),r.on("click",function(){var e=(a=angular.element("#tag-menu")).scope();e&&e.setTagName(n.showCaretMenu);e=r.offset();a.css({left:e.left,top:e.top+r[0].offsetHeight}),a.show(),o=!0,Hammer(document).on("tap",i)})}}]).directive("threadCommentEdit",["$compile","$timeout",function(i,c){return function(o,r,e){var a=$("<form class='pure-form pure-form-stacked' ng-submit='updateComment(editData)'><fieldset><textarea class='pure-input-1' ng-model='editData.commentEdited' auto-resize enter-cmd='updateComment(editData)' mentions-textarea='{{editData.comment.id + \"-edit-comment\"}}'></textarea><a \t\t\tclass='pure-button mention-button' title='Add mention to notify others about the comment' add-mentions-symbol='{{editData.comment.id + \"-edit-comment\"}}'>@</a> <button class='pure-button pure-button-primary'>Comment</button> <a class='pure-button' ng-click='hideCommentEdit(\"hide-comment-edit\")'>Cancel</a></fieldset></form>");o.$on("hide-comment-edit",function(){r[0].parentNode.querySelector(".comment-section").style.display="block";var e=angular.element(a[0]).scope();e&&e.$destroy(),a.remove()}),o.$on("main-comments-closed",function(){o.editData&&o.$parent.$parent.updateComment(o.editData)}),o.$on("edit-"+e.threadCommentEdit,function(e,t){r[0].parentNode.querySelector(".comment-section").style.display="none";var n=o.$new();n.editData=t,n.editData.commentEdited=t.comment.comment_text,r.append(a),i(a)(n),c(function(){o.$broadcast("do-auto-resize");var e=a.find("textarea");e&&e.focus()})})}}]).directive("hideOnCommentEdit",function(){return function(e,t,n){e.$on("cancel-edit-"+n.hideOnCommentEdit,function(){t.show()}),e.$on("bedit-"+n.hideOnCommentEdit,function(e){t.hide()})}}).directive("boardCommentEdit",["$compile","$timeout","$http",function(r,a,i){return function(t,n,e){var o=null;t.$on("cancel-edit-"+e.boardCommentEdit,function(){o&&(o.remove(),o=null)}),t.$on("bedit-"+e.boardCommentEdit,function(e){n[0].querySelector("textarea")||i.get("/partials/board-comment-editor.html",{cache:!0}).then(function(e){e=e.data,o=$(e),n.append(o),r(o)(t),a(function(){t.$broadcast("do-auto-resize");var e=o.find("textarea");e&&e.focus()})})})}}]).directive("boardThreadReply",["$compile","$http","$timeout",function(a,i,c){return function(t,n,e){var o=null,r=!1;t.$on("hide-reply-thread."+e.boardThreadReply,function(){o.remove(),o=null,r=!1}),t.$on("breply-"+e.boardThreadReply,function(e){i.get("/partials/thread-reply.html",{cache:!0}).then(function(e){e=e.data,r||(o=$(e),n.append(o),a(o)(t),c(function(){t.$broadcast("do-auto-resize");var e=o.find("textarea");e&&e.focus()})),r=!0})})}}]).directive("threadMenu",["Helpers",function(e){return function(a,i,e){function c(){animate({el:i,scaleX:[1,.8],scaleY:[1,.8],opacity:[1,0],duration:300,complete:function(e){e.forEach(function(e){e.style.display="none"}),Hammer(document).off("tap",c)}})}a.$on("open-thread-menu",function(e,t){i.is(":visible")?c():function(e,t,n){a.currentCommentScope={comment:t,thread:n};var o=e.offsetLeft,n=document.querySelector(".comments-area"),r=e.offsetTop-n.scrollTop;animate({el:i,begin:function(){i.css({visibility:"hidden",display:"inline-block"}),i.css({left:o-i[0].offsetWidth+e.offsetWidth,top:r+e.offsetHeight,visibility:"visible"})},opacity:[0,1],scaleX:[.8,1],scaleY:[.8,1],duration:300,complete:function(){Hammer(document).on("tap",c)}})}(t.targetEvent.currentTarget,t.comment,t.thread)})}}]).directive("commentOptionsMenu",function(){return function(i,c,e){function n(e,t,n){i.currentCommentScope={comment:t,thread:n};var o=$(e),t=o.parents(".comment-thread"),n=t.position(),t=t.find(".thread-section").position(),o=o.position(),r=n.left+t.left+o.left,a=n.top+t.top+o.top,o=gwtGetScaleFactor();r/=o,a/=o,animate({el:c,begin:function(){c.css({visibility:"hidden",display:"inline-block"}),c.css({left:r,top:a+e.offsetHeight,visibility:"visible"})},opacity:[0,1],scaleX:[.8,1],scaleY:[.8,1],duration:300,complete:function(){Hammer(document).on("tap",l)}})}function l(){animate({el:c,scaleX:[1,.8],scaleY:[1,.8],opacity:[1,0],duration:300,complete:function(e){e.forEach(function(e){e.style.display="none"}),Hammer(document).off("tap",l)}})}i.$on("open-comment-options-menu",function(e,t){c.is(":visible")?l():n(t.targetEvent.currentTarget,t.comment,t.thread)}),n(i.$parent.currentCommentScope.targetEvent.currentTarget,i.currentCommentScope.comment,i.currentCommentScope.thread)}}).directive("mentionsPopup",["MentionsPopup","MentionsEditor",function(l,e){return function(e,c,t){l.onEvents(e,c,t.mentionsEvent,function(e,t,n){var o,r=$(e),a=r.parents(".comment-thread"),i=a.position();i?(o=a.find(".thread-section").position(),a=r.position(),r=i.left+o.left+a.left,a=i.top+o.top+a.top+e.offsetHeight,e=gwtGetScaleFactor(),l.show(c,r/=e,a/=e)):console.error("mentions-popup: invalid structure")})}}]).directive("mentionsPopup2",["MentionsEditor","MentionsPopup",function(e,r){return function(e,o,t){r.onEvents(e,o,"open-mentions-selector",function(e){$(e);var t=e.getBoundingClientRect(),n=t.left,e=t.top+e.offsetHeight;r.show(o,n,e)})}}]).directive("popupEffect",function(){return function(e,t,n){t.show()}}).directive("showEffect",["$timeout",function(r){return function(t,n,e){var o=!1;t.$on(e.showEffect,function(){o?animate({el:n,opacity:[1,0],scaleX:[1.05,.8],scaleY:[1.05,.8],duration:200,easing:"easeOutQuad",complete:function(e){e.forEach(function(e){e.style.display="none"}),n[0].dataset.closeCallback&&t[n[0].dataset.closeCallback]()}}):(n[0].dataset.showCallback&&t[n[0].dataset.showCallback](),animate({el:n,opacity:[0,1],scaleX:[1.05,1],scaleY:[1.05,1],duration:300,easing:"easeInQuad",begin:function(e){e.forEach(function(e){e.style.display="block"})},complete:function(){t.$broadcast("do-auto-resize");var e=n.find("textarea");e&&r(function(){e.focus()})}})),o=!o})}}]).directive("autoResize",[function(){return function(e,t,n){function o(e,t){t&&(e.style.height="1px"),""!==n.autoResize&&(e.style.height=n.autoResize),e.scrollHeight<130?e.style.height=1+e.scrollHeight+"px":(e.style.height="130px",e.style.overflow="auto")}t[0].style.overflow="hidden",t.on("keyup",function(e){o(t[0])}),e.$on("do-auto-resize",function(){o(t[0],!0)})}}]).directive("formAutoButtons",["$timeout","Helpers",function(r,a){return function(e,n,t){function o(){var e=n[0].querySelectorAll(".pure-button");a.domArray(e).forEach(function(e){animate({el:e,duration:100,opacity:[1,0],easing:"easeInOutQuart",complete:function(){e.style.display="none"}})})}e.$on(t.formAutoButtons,function(){o()}),a.domArray(n[0].querySelectorAll(".pure-button")).forEach(function(e){e.style.display="none"}),a.domArray(n[0].querySelectorAll("textarea")).forEach(function(e){e.addEventListener("focus",function(e){var t;t=n[0].querySelectorAll(".pure-button"),a.domArray(t).forEach(function(e){animate({el:e,duration:100,opacity:[0,1],easing:"easeInOutQuart",complete:function(){e.style.display="inline-block"}})})}),e.addEventListener("blur",function(e){var t=n[0].querySelector("textarea");t&&0==t.value.length&&r(function(){o()})})})}}]).directive("threadReply",["$timeout",function(r){return function(e,t,n){function o(){t[0].style.display="block",r(function(){var e=t[0].querySelector("textarea");e&&e.focus()})}e.thread.comments.length<2&&(t[0].style.display="none"),e.$on("main-comments-closed",function(){e.thread&&e.saveReply(e.thread)}),e.$on(n.threadReply,function(e,t){o()}),e.replyThreadId===n.threadReply&&o()}}]).directive("markdownInit",function(){return function(n,e,t){boardLoadedStream.onValue(function(){$.cachedScript(_config.staticPrefix+"/resources-static-1/js/app-keep/lib/marked-0.3.3.min.js").done(function(e,t){n.$broadcast("markdown-lib-loaded")})})}}).directive("showFreePlan",["AuthService",function(o){return function(e,t,n){o.currentBoard().isBoardAccountExpired()?t.show():t.hide()}}]).directive("themeChanged",[function(){return function(e,n,t){themeChangedStream.onValue(function(e){var t=n.attr("class");n.attr("class",t.replace(/theme-\S+/,"theme-"+e))})}}]).directive("appContext",[function(){return function(e,t,n){var o=getApp(),r=t.attr("class");t.attr("class",r+" "+o+"-app")}}]).directive("boardComments",function(){return function(t,e,n){t.$on("comments-loaded",function(e){t.commentThreads.forEach(function(e){console.log("thread",e)})})}}).directive("commentThread",["$timeout","CommentPositionFactory","Comments2Factory",function(e,t,n){return function(e,i,t){i.css({pointerEvents:"auto"});uiutils.getPosition(i).width;i.left=0,i.top=0,e.$on("hide.thread",function(){i.hide()}),e.$on("show.thread",function(){i.show()}),e.$on("thread.resolved.animate."+e.thread.threadid,function(e,t){var n=$("#thread-resolved-target"),o=i.find(".thread-section"),r=uiutils.getPosition(n),a=uiutils.getPosition(i),n=gwtGetScaleFactor(),o=(r.left-a.left+.2*o.width())/n,n=(r.top-a.top)/n;animate({el:i,translateX:o,translateY:n,scaleX:.2,scaleY:.2,easing:"easeOutExpo",begin:function(){i.css({transformOrigin:"left top"})},complete:function(){t.done(),i.css({transform:""})}})}),e.$on("scrollToBottom."+e.thread.threadid,function(e,t){i.find("ul").each(function(e){this.scrollTop=this.scrollHeight})})}}]).directive("createComment",["$http","$timeout","$compile",function(t,c,l){return function(o,r,e){var a=null;function i(t,e){r.show(),r.addClass("show-before");var n=$(e),e=uiutils.getPosition(n);r.css({left:e.left-t[1].offsetWidth+72,top:e.top+n.height()+18}),c(function(){o.$broadcast("do-auto-resize");var e=t.find("textarea");e&&e.focus()})}r.addClass("hide-before"),o.$on("hide-create-thread",function(){r.hide(),r.removeClass("show-before"),r.addClass("hide-before")}),o.$on("create-comment-thread",function(e,n){a?i(a,n):t.get("/partials/create-comment-editor.html",{cache:!0}).then(function(e){var t;t=e.data,e=n,a=$(t),r.append(a),i(a,e),l(a)(o)})})}}]).directive("htmlLayer",["$window",function(e){return function(e,o,t){function n(){var e=gwtGetTransform(),t=e.matrix.dx.toFixed(8),n=e.matrix.dy.toFixed(8);o.css({transform:"matrix("+e.matrix.xx.toFixed(8)+","+e.matrix.yx.toFixed(8)+","+e.matrix.xy.toFixed(8)+","+e.matrix.yy.toFixed(8)+","+t+","+n+")"})}o.css({zIndex:5,position:"fixed",left:0,top:0,pointerEvents:"none",transformOrigin:"0 0"}),globalStreams.backgroundMoveStream.onValue(function(e){"start"===e.type||"move"!==e.type&&"end"!==e.type||n()}),globalStreams.scaleAtStream.onValue(function(e){n()}),globalStreams.surfaceTransformStream.onValue(function(e){n()})}}]),angular.module("myApp.factories",[]).factory("UserInfo",["$rootScope","accountType",function(t,e){function n(){}n.prototype.isTrial=function(){return this.defaultAccountType===e.trial},n.prototype.isDefaultAccountExpired=function(){return this.defaultAccountExpired},n.prototype.updateDefaultAccountType=function(e){this.defaultAccountType=e,t.$$phase||t.$apply()},n.prototype.isLoggedIn=function(){return this.loggedIn};return n.prototype.isShowBoardUsers=function(){return!(4==(4&this.properties))},n.prototype.isLibraryManualShowHide=function(){return 8==(8&this.properties)},n.prototype.isAccountRoleReadOnly=function(){return 2===this.accountRole},n.prototype.isAccountRoleAdminOrPrimaryOwner=function(){return 1===this.accountRole||3===this.accountRole},n.prototype.isAnonymous=function(){return void 0===this.email},n.prototype.isGoogleUser=function(){return 2==this.authType},n}]).factory("MentionsEditor",["$rootScope","BoardUsers",function(i,t){var n,o=[],r=[],c=!1,a=0,l="open-mentions-selector";function s(e,t,n){var o=e.getSelectionEnd(),r=e.textAreaValue().slice(0,o),a=e.textAreaValue().slice(o),o=/(^[^\s\n;,?!:]+)/.exec(a);o&&2<=o.length&&(r+=o[1],a=a.slice(o[1].length));t=r.replace(/\S*@([^\s\n;,?!:]*)$/,"@"+t);0==a.length&&(a=" "),e.setTextareaValue(t+a),d(e,t.length+1);n=f(n);return i.$broadcast(n),c=!1,e.$$phase||e.$digest(),c}function u(t){t=(t=0<t.length&&"@"==t[0]?t.slice(1):t).replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&");return o.filter(function(e){return new RegExp("("+t+")","ig").exec(e.mention)})}function d(e,t){setTimeout(function(){e.setCursorPosition(t),e.$broadcast("do-auto-resize"),e.textAreaFocus()},50)}function f(e){return e?"hide-"+e:"hide-open-mentions-selector"}var p={init:function(e){t.accountUsersForBoard(function(){o=[{mention:"team",display:"@team",help:"Notify everyone in this team"},{mention:"thread",display:"@thread",help:"Notify everyone in this comment thread"},{mention:"mute",display:"@mute",help:"Email notifications are not sent"}],t.mates.forEach(function(e){o.push({mention:e.email,display:e.email,help:""})}),r=o})},handleEdit:function(e,t){var n=e.getSelectionEnd(),o=e.textAreaValue().slice(0,n).match(/\S*@[^\s\n;,?!:]*$/m),n=o?o[0]:null,o=f(t);return n?(r=u(n),(a=a>=r.length?0:a)<0&&(a=0),0==r.length?(i.$broadcast(o),c=!1):(c||(a=0),c=!0,i.$broadcast(t||l,{elem:e.getTextareaElement()}))):(i.$broadcast(o),c=!1),c},addMentionSymbol:function(e,t){var n=e.getSelectionEnd(),o=e.textAreaValue().slice(0,n),n=e.textAreaValue().slice(n);return 0<o.length&&!o.match(/\s$/)&&(o+=" "),e.setTextareaValue(o+"@"+n),r=u("@"),i.$broadcast(t||l,{elem:e.getTextareaElement()}),d(e,(o+"@").length),e.$$phase||e.$digest(),c},handleSelectKey:function(e,t,n){switch(t){case 38:return 1<r.length&&--a,c;case 40:return a<r.length-1&&++a,c;case 13:if(0<=a&&a<r.length)return s(e,r[a].mention,n)}},addMention:function(e,t){n&&s(n,e,t)},shouldHandleKeyDown:function(e){return r&&1==r.length?13==e:c},handleEvent:function(e,t,n){p.handleEdit(t,n)},getSelectionIndex:function(){return a},getMentions:function(){return r},hide:function(){c=!1,a=0,n=null},setCurrentTextArea:function(e){e=angular.element(e).scope();e&&(n=e)}};return p}]).factory("MentionsPopup",["MentionsEditor",function(a){var t={onEvents:function(n,o,e,r){cancelStream.onValue(function(){t.hide(o)}),n.$on("hide-"+e,function(){o.is(":visible")&&(t.hide(o),n.$$phase||n.$digest())}),n.$on(e,function(e,t){o.is(":visible")||(r(t.elem),a.setCurrentTextArea(t.elem)),n.$$phase||n.$digest()}),n.$on("mentions-highlight-updated",function(){n.mentionsHighlightUpdated(),setTimeout(function(){var e=o[0].querySelector(".mention-highlight");e&&e.scrollIntoView({block:"nearest",inline:"nearest"})},1)})},show:function(e,t,n){animate({el:e,begin:function(){e.css({visibility:"hidden",display:"inline-block"}),e.css({left:t,top:n,visibility:"visible"})},opacity:[0,1],scaleX:[.8,1],scaleY:[.8,1],duration:300,complete:function(){}})},hide:function(e){animate({el:e,scaleX:[1,.8],scaleY:[1,.8],opacity:[1,0],duration:300,complete:function(e){e.forEach(function(e){e.style.display="none"})}}),a.hide()}};return t}]).factory("OrganizationInfo",[function(){function e(){}return new e}]).factory("SubscriptionInfo",[function(){function t(){}return t.prototype.legacySeatSubscription=1,t.prototype.legacyPlanSubscription=2,t.prototype.stripeSubscription=3,t.prototype.isExtended=function(){return!!this.subscription_type},t.prototype.extend=function(e){return _.extend(this,e,t.prototype)},t.prototype.isLegacySeatSubscription=function(){return this.subscription_type==this.legacySeatSubscription},t.prototype.isLegacyPlanSubscription=function(){return this.subscription_type==this.legacyPlanSubscription},t.prototype.isStripeSubscriptionOrSubscription=function(){return void 0===this.subscription_type||this.subscription_type===this.stripeSubscription},new t}]).factory("AcceptAcccountInfo",[function(){function e(){}return e.prototype.setAccounts=function(e){return this.accounts=e,this},new e}]).factory("AvatarUrl",[function(){function e(){}return e.prototype.makeUrl=function(e,t){return makeUrl(e,t)},new e}]).factory("AuthService",["$rootScope","$location","anonymous","UserInfo",function(t,e,n,o){function r(){"undefined"!=typeof backendAuthService&&backendAuthService.currentAuthData({board_id:c.boardId}).then(function(e){_.extend(i,e.user,o.prototype),globalStreams.reduxStream.push({type:"currentUser",payload:{currentUser:i}}),_.extend(c,e.board,BoardInfo.prototype),globalStreams.reduxStream.push({type:"currentBoard",payload:{currentBoard:c}}),t.$digest(),globalStreams.currentUserStream.push(i)})}var a,i,c;return"undefined"!=typeof initialState&&(a={},"undefined"!=typeof _initialUser&&void 0!==_initialUser.currentTeam&&(a=_initialUser.currentTeam),i={email:_initialUser.email,avatarUrl:_initialUser.avatarUrl,sketchboardAvatar:_initialUser.sketchboardAvatar,firstName:"",lastName:"",displayName:"guest",defaultAccountName:"",internal:initialState.internal,defaultAccountExpired:_initialUser.defaultAccountExpired,defaultAccountType:initialState.defaultAccountType,loggedIn:"guest"!==initialState.userType,properties:_initialUser.properties||0,currentTeam:a,accountRole:_auState.role,org_id:_initialUser.org_id},_.extend(i,o.prototype),globalStreams.reduxStream.push({type:"currentUser",payload:{currentUser:i}}),c={boardId:initialState.boardId,name:initialState.diagramName,updatedAt:-1,owner:initialState.diagramOwner,accountname:"",diagramType:initialState.diagramType,visibility:-1,diagramOwned:initialState.diagramOwned,editable:initialState.diagramEditable},_.extend(c,_initialBoard,BoardInfo.prototype),globalStreams.reduxStream.push({type:"currentBoard",payload:{currentBoard:c}}),r()),"/upgradeinfo"==e.path()&&e.path("/").search({}),{login:function(){},logout:function(){},isLoggedIn:function(){return"undefined"!=typeof initialState&&i.isLoggedIn()},currentUser:function(){return i},currentBoard:function(){return c},refresh:function(){r()}}}]).factory("Comments2Factory",["$rootScope","$timeout","AuthService","BoardUsers",function(n,e,a,i){var r={},c={};function o(e){n.$broadcast(c.constCommentsLoaded+e),globalStreams.reduxStream.push({type:"comments-save",payload:{commentThreads:c.commentThreads}})}return c.constCommentsLoaded="comments-loaded",c.loadResult=null,c.commentThreads=null,n.$on("comment.create",function(e,t){c.appendComment(t),globalStreams.reduxStream.push({type:"new-comment",payload:{newComment:t}}),n.$broadcast("do.comment.create",t)}),n.$on("comment.update",function(e,t){c.updateComment(t),n.$broadcast("do.comment.update",t)}),n.$on("comment.update.switch.shapes",function(e,t){c.updateCommentSwitchShapes(t),n.$broadcast("do.comment.update.switch.shapes",t)}),n.$on("comment.delete",function(e,t){c.deleteComment(t),n.$broadcast("do.comment.delete",t)}),n.$on("thread.resolve",function(e,t){c.updateThreadResolveStatus(t),c.appendComment(t),n.$broadcast("do.thread.resolve",t)}),c.loadCommentThreads=function(t){if(c.commentThreads)return _.each(c.commentThreads,function(e){e.showAll=!1,e.uuat&&(e.uat=e.uuat,e.uuat=null)}),void e(function(){o(t)});publicBackendComments.listComments({board_id:a.currentBoard().boardId}).then(function(e){c.loadResult=e.ok,c.commentThreads=_.uniq(e.data,!1,function(e){return e.threadid}),Object.keys(r).forEach(function(e){var t=c.findThread(e);t&&(t.open=r[e])}),o(t)})},c.removeComment=function(e,t){var n="Are you sure you want to delete comment? This cannot be undone.";e.comment.topic&&(n="Are you sure you want to delete whole comment thread? All comments in this thread will be deleted. This cannot be undone."),confirm(n)&&backendComments.deleteComment({board_id:a.currentBoard().boardId,site_id:gwtGetSiteId(),comment_id:e.comment.id,thread_id:e.thread.threadid}).then(function(e){t(e)})},c.deleteComment=function(e){var t,n;e.comment.topic?0<=(n=c.findThreadIndex(e.thread.threadid))&&c.commentThreads.splice(n,1):(t=c.findThread(e.thread.threadid))&&0<=(n=c.findCommentIndex(t.comments,e.comment.id))&&t.comments.splice(n,1),globalStreams.reduxStream.push({type:"comments-save",payload:{commentThreads:c.commentThreads}})},c.appendComment=function(t){var e=_.findIndex(c.commentThreads,function(e){return e.threadid==t.thread.threadid});0<=e?((e=c.commentThreads[e]).resolved=t.thread.resolved,e.uuat=t.comment.uat,e.comments.push(t.comment)):(t.thread.comments.push(t.comment),c.commentThreads.unshift(t.thread)),globalStreams.reduxStream.push({type:"comments-save",payload:{commentThreads:c.commentThreads}})},c.updateComment=function(e){var t,n=c.findThread(e.thread.threadid);n&&(0<=(t=c.findCommentIndex(n.comments,e.comment.id))&&(n.comments.splice(t,1,e.comment),n.uuat=e.comment.uat),globalStreams.reduxStream.push({type:"thread-save",payload:{thread:n}}))},c.updateCommentSwitchShapes=function(e){var t=c.findThread(e.thread_id);t&&(t.shape_ids=e.shape_ids,globalStreams.reduxStream.push({type:"thread-save",payload:{thread:t}}))},c.updateThreadResolveStatus=function(e){var t=c.findThread(e.thread.threadid);return t&&(t.resolved=e.thread.resolved,t.open=!1,t.forceShowReplies=!1,globalStreams.reduxStream.push({type:"thread-save",payload:{thread:t}})),t},c.closeAll=function(){c.commentThreads.forEach(function(e){c.openThread(e,!1)})},c.openThread=function(e,t,n){var o=c.findThread(e.threadid);o&&(o.open=t,e.open=t,(r[e.threadid]=t)||delete r[e.threadid],globalStreams.reduxStream.push({type:"thread-save",payload:{thread:e}}))},c.updateThreadPosition=function(e,t){e=c.findThread(e);e&&(e.dimension=t)},c.findThread=function(t){return _.find(c.commentThreads,function(e){return e.threadid==t})},c.findThreadIndex=function(t){return _.findIndex(c.commentThreads,function(e){return e.threadid==t})},c.findCommentIndex=function(e,t){return _.findIndex(e,function(e){return e.id==t})},c.postSaveComment=function(e,t,n,o,r){e&&""!=e?(e={board_id:a.currentBoard().boardId,site_id:gwtGetSiteId(),comment:e,active_users:i.activeUsers()},t&&(e.thread_id=t.threadid),n&&(e.shape_ids=n),backendComments.createComment(e).then(function(e){o(e)})):r&&r()},c.postUpdateComment=function(e,t){e={board_id:a.currentBoard().boardId,site_id:gwtGetSiteId(),comment:e.commentEdited,comment_id:e.comment.id,thread_id:e.thread.threadid};backendComments.updateComment(e).then(function(e){t(e)})},c.postUpdateThreadResolveStatus=function(e,t){backendComments.updateThreadResolveStatus({board_id:a.currentBoard().boardId,thread_id:e,site_id:gwtGetSiteId(),resolved:t})},c.getSelectedShapes=function(){var e,t,n=JSON.parse(gwtGetSelectedItems());return 0<n.length&&(e=(e="").length>(t=350)?e.substring(0,t)+"...":e,0),{selectedText:"",selectedShapeIds:_.map(n,function(e){return e.clientId})}},c.isSystemOrOthersOwn=function(e){return!(!e||!c.isSystemComment(e))||!(!e||e.email===a.currentUser().email)},c.isSystemComment=function(e){return!(!e||!e.opts)&&1==(1&e.opts)},c.shouldDisableCommentMenu=function(e,t){return!!c.isSystemComment(t)||(!0===e.resolved&&!t.topic||!(!t||t.topic||t.email===a.currentUser().email))},c}]).factory("Helpers",["$location",function(e){var t=0<=navigator.platform.toUpperCase().indexOf("MAC");return{parseEmailDomain:function(e){e=e.split("@");return 2==e.length?e[1]:null},format:function(){var e="";0<arguments.length&&(e=arguments[0]);for(var t=1;t<arguments.length;++t)e=e.replace(/\{\}/,arguments[t]);return e},jsonParse:function(e){return angular.fromJson(e)},currentBoardId:function(){var e=this.currentBoardFullId().split("-");return 0<e.length?e[0]:this.currentBoardFullId()},currentBoardVersion:function(){var e=this.currentBoardFullId().split("-");return 2==e.length?e[1]:""},currentBoardFullId:function(){return location.pathname.substring(1)},isBoardVersion:function(){return 2==this.currentBoardFullId().split("-").length},toggle:function(e,t){e.$broadcast("event:toggle:"+t)},capitalize:function(e){return e.substring(0,1).toUpperCase()+e.substring(1)},isMac:function(){return t},isOutsideElement:function(e,t){return!e.is(t)&&0===e.has(t).length},domArray:function(e){return Array.isArray(e)?e:e.nodeType?[e]:e instanceof NodeList||e instanceof HTMLCollection?Array.prototype.slice.call(e):e.get()},isPrimaryOwner:function(e){return 1==e.role}}}]).factory("TutorialHelpers",["$location","$rootScope",function(n,o){return{showTutorialShare:function(){var t=null,t=globalStreams.shapeAddedStream.onValue(function(e){t(),setTimeout(function(){n.path("/tutorial").search({share:!0}),o.$apply()},7e3)})}}}]).factory("DirectiveHelpers",["$rootScope","$compile","$document",function(s,u,d){return{injectLibrary:function(t,n,e,o,r,a){var i=!1;function c(){n.css("display","block")}function l(){n.css("display","none")}s.$on(o.showOn,function(){c(),i||(t.$apply(function(){var e=angular.element("<div ng-include src=\"'"+r+"'\">");n.html(u(e)(t))}),i=!0),a&&a()}),s.$on(o.hideOn,function(){l()}),d.on(o.hideAlt1,function(){l()}),d.on(o.showAlt1,function(){c()})}}}]).factory("DeleteLegacyCookies",["$cookies",function(t){return{doIt:function(){for(var e in t.getAll())0==e.indexOf("aboard-")&&t.remove(e)}}}]).factory("CommentPositionFactory",function(){var e={},a={};return e.resetAllocations=function(){a={}},e.position=function(e,t){var n={left:0,top:0};return n=e.dimension?function e(t,n,o){var r=t+"px"+n+"px";return!a[r]||a[r]&&a[r]===o?(a[r]=o,{left:t,top:n}):e(t-30,n,o)}(e.dimension.left-25,e.dimension.top-25,e.threadid):n},e}).factory("TaxFactory",function(){var e={},n=["BE","EL","LT","PT","BG","ES","LU","RO","CZ","FR","HU","SI","DK","HR","MT","SK","DE","IT","NL","FI","EE","CY","AT","SE","IE","LV","PL","UK","GB"];return e.isEUCountry=function(t){return 0<_.filter(n,function(e){return e==t}).length},e.isFinland=function(e){return"FI"===e},e.resolveCreditCardCountry=function(e){return _config&&_config.devCountryCode&&2==_config.devCountryCode.length?_config.devCountryCode:null!=e&&""==e?"FI":e},e}).factory("PlanFactory",["AccountService",function(o){var r={plans:[]};r.fetch=function(){backend.allPlans().then(function(e){r.plans=e,_.each(r.plans,function(e){e.features=function(e){if("org-standard"===e)return[{text:"Easily split work between different user groups",title:""},{text:"Multiple teams for a user and charged only once",title:""},{text:"Single billing for all teams",title:""},{text:"Unlimited private teams",title:""},{text:"Team level access rights",title:""},{text:"Store more images and versions",title:""}];var t=[{text:"personal"!==e?"Unlimited personal & team boards":"Unlimited personal boards",title:"personal"!==e?"Create private personal and team boards.":"Create private personal boards."},{text:"Search boards' content",title:"All your private boards will be searchable which your future self will be very grateful"},{text:"Storage for images & revisions "+r.spaceFor(e),title:"Sketch on top of images and snapshot important sketches."}];"personal"!==e&&(t.push({text:"Team Comments",title:""}),t.push({text:"Presentation",title:""}),t.push({text:"Slack Integration",title:""}));!function(e){return"medium"===e||"small"===e}(e)||t.push({text:"Priority Email Support",title:""});return t}(e.id_name)})})};var n=[];return r.featuresFor=function(t){var e=_.find(r.plans,function(e){return e.id_name==t});return e?e.features:n},r.planName=function(t){var e=_.find(r.plans,function(e){return e.id_name==t});return e?e.name:""},r.priceFor=function(t,e){var n=_.find(r.plans,function(e){return e.id_name==t});return n&&e==o.yearly.id?n.amountYearly/100:n?n.amount/100:""},r.collaboratorsFor=function(t){var e=_.find(r.plans,function(e){return e.id_name==t});return e?e.max_members:""},r.spaceFor=function(t){var e=_.find(r.plans,function(e){return e.id_name==t});return e&&e.space<1e3?e.space+" MB":e?e.space/1e3+" GB":""},r}]).factory("BoardUsers",["AuthService","AvatarUrl","anonymous",function(n,t,o){var r={mates:[],defaultAvatarURL:"https://dly2br18d18gh.cloudfront.net/img/user_icon_100x100.png",accountUsersForBoard:function(t){return r.mates=[],"undefined"!=typeof backend&&globalStreams.boardLoadedWrapStream.onValue(function(){backend.accountUsersForBoard({boardId:n.currentBoard().boardId}).then(function(e){_.each(e.users,function(t){t.username=t.displayName,_.find(r.mates,function(e){return e.email==t.email})||l(t)}),t()})}),r.mates},avatarUrl:function(e){e=r.findUser(e);return e?t.makeUrl(e,50):r.defaultAvatarURL},findUser:function(t){return _.find(r.mates,function(e){return e.email===t})},reloadUsers:function(e){r.mates=[],globalStreams.reloadBoardUsersStream.push()}};r.statusChangedStream=new Bacon.Bus;var a=6e4;function i(e){_.each(e,function(t){var e=_.find(r.mates,function(e){return t.email==e.email});e?e.username=t.username:l(t)}),_.chain(r.mates).filter(function(t){return _.find(e,function(e){return t.email===e.email})}).each(function(e){e.online=!0,e.expires=(new Date).getTime()+a})}var c=null;function l(e){e.avatarUrl&&""!=e.avatarUrl||(e.avatarUrl=r.defaultAvatarURL),e.email&&""!=e.email&&e.email!=o&&r.mates.push(e)}return globalStreams.websocketMouseStream.onValue(function(e){var t=(new Date).getTime();c&&t<c.when+4e3||(c={when:t,email:e.email},i([e]))}),globalStreams.usersStream.onValue(function(e){i(e)}),r.activeUsers=function(){return _.chain(r.mates).filter(function(e){return e.online}).map(function(e){return e.email}).value()},function e(){setTimeout(function(){var t;t=(new Date).getTime(),_.each(r.mates,function(e){e.online&&t>e.expires&&e.email!=n.currentUser().email?e.online=!1:e.email==n.currentUser().email&&(e.online=t<=mousews.userLastActivity+a)}),function(){for(var e=r.mates.length-1;0<=e;--e){var t=r.mates[e];t.online||"guest"!=t.username||r.mates.splice(e,1)}}(),r.mates=_.sortBy(r.mates,function(e){return e.online?-1:1}),r.statusChangedStream.push(),e()},8e3)}(),r}]).factory("BoardPositionFactory",["AuthService",function(o){function r(){if(void 0===o.currentBoard())return null;var e=webStorage.get("pos_"+o.currentBoard().boardId),t={};return t=e?JSON.parse(e):t}var a=null;var e=null;function t(t){gwtIsOkToSaveZoom()&&(clearTimeout(e),e=setTimeout(function(){var e;r()&&((e=r()).dx=t.dx,e.dy=t.dy,e.zoom=t.xx,webStorage.set("pos_"+o.currentBoard().boardId,JSON.stringify(e)))},500))}function n(e){var t;gwtIsOkToSaveZoom()&&((t=r()).map=e,webStorage.set("pos_"+o.currentBoard().boardId,JSON.stringify(t)))}return globalStreams.boardScaledStream.onValue(function(e){try{var t=Number(e.toFixed(3));n=t,gwtIsOkToSaveZoom()&&(clearTimeout(a),a=setTimeout(function(){var e=r();e&&(e.zoom=n,webStorage.set("pos_"+o.currentBoard().boardId,JSON.stringify(e)))},500))}catch(e){console.error("BoardPositionFactory.boardScaledStream failed",e)}var n}),globalStreams.backgroundMoveStream.onValue(function(e){("move-end"===e.type||"move"===e.type)&&t(e.matrix)}),globalStreams.surfaceTransformStream.onValue(function(){t(gwtGetTransform().matrix)}),globalStreams.mapViewStateStream.onValue(function(e){e?n(e):(n(e),t(gwtGetTransform().matrix))}),{getCurrent:r}}]);var BoardInfo=function(){};BoardInfo.prototype.getProClass=function(){var e="context-icon-pro",t="";return 1==this.diagramType?e:t},BoardInfo.prototype.getTitle=function(){return 1==this.diagramType?"Business Board":"Free Board"},BoardInfo.prototype.isFree=function(){return 0==this.diagramType},BoardInfo.prototype.isPublic=function(){return this.isFree()},BoardInfo.prototype.isPro=function(){return 1==this.diagramType},BoardInfo.prototype.isPasswordProtected=function(){return this.passwordProtected},BoardInfo.prototype.isPrivate=function(){return 0==this.visibility&&1==this.diagramType},BoardInfo.prototype.isPrivateTeam=function(){return 2==this.visibility&&1==this.diagramType},BoardInfo.prototype.iAmTheOwner=function(){return"me"===this.owner},BoardInfo.prototype.noOwner=function(){return"undefined"===this.owner||""===this.owner},BoardInfo.prototype.isOwnedBySomeoneElse=function(){return!this.iAmTheOwner()&&this.diagramOwned},BoardInfo.prototype.isAccountVisibility=function(){return 2==this.visibility&&1==this.diagramType},BoardInfo.prototype.isPaidBoard=function(){return this.paidBoard},BoardInfo.prototype.isBoardAccountExpired=function(){return this.boardAccountExpired},BoardInfo.prototype.isCreatedBeforeGalleryLaunch=function(){return this.createdAt<_config.galleryLaunchDate},BoardInfo.prototype.setVisibility=function(e){this.visibility=e,globalStreams.reduxStream.push({type:"currentBoard",payload:{currentBoard:this}})},BoardInfo.prototype.setBoardInfo=function(e){e=_.extend(this,e);return globalStreams.reduxStream.push({type:"currentBoard",payload:{currentBoard:e}}),e},BoardInfo.prototype.isSketchMode=function(){return 1==(1&this.properties)},BoardInfo.prototype.isShowCommentsPublicly=function(){return 2==(2&this.properties)},BoardInfo.prototype.isUserBoardTeamMember=function(){return this.userIsBoardTeamMember},angular.module("myApp.services",[]).service("AppStateService",[function(){this.isDialogOpen=function(){return angular.element(document.activeElement).is(":focus")}}]).service("SettingsService",function(){this.showWelcomeGuideNextTime=function(e){"undefined"!=typeof boardService&&boardService.showWelcomeGuideNextTime({show:e})}}).service("ClipboardService",["Helpers",function(n){this.copyToClipboard=function(){var e,t;"undefined"!=typeof backendClipboard&&(e=gwtCopy(),t=n.currentBoardFullId(),backendClipboard.copyToClipboard({boardId:t,items:e}).then(function(e){}))},this.pasteFromClipboard=function(){var e;"undefined"!=typeof backendClipboard&&(e=n.currentBoardFullId(),backendClipboard.pasteFromClipboard(e).then(function(e){e&&gwtPaste(e.items)}))}}]).service("BrowserService",function(){var e=function(){var e=document.createElement("div");try{e.contentEditable="PLAINtext-onLY"}catch(e){return!1}return"plaintext-only"==e.contentEditable}();this.supportContentEditablePlainText=function(){return e}}).service("CommentsService",["$rootScope","AuthService",function(n,e){this.applyCommentOperation=function(e,t){n.$broadcast(e,t)}}]).service("URLParser",function(){this.parseURL=function(e){var t=document.createElement("a");return t.href=e,t}}).service("ImageService",["AuthService",function(n){this.loadThumbnails=function(e,t){"undefined"!=typeof backendProfileService&&backendProfileService.loadThumbnails({boardId:n.currentBoard().boardId,offset:e,max:t}).then(function(e){gwtLoadedImages(e)})}}]).service("LibrarySettingsService",["$rootScope",function(e){this.showLibrarySettings=function(){e.$broadcast("show-library-settings")},this.hideLibrarySettings=function(){e.$broadcast("hide-library-settings")}}]).service("ImageLibraryService",["$rootScope",function(e){this.showImageLibrary=function(){e.$broadcast("show-image-library")},this.hideImageLibrary=function(){e.$broadcast("hide-image-library")}}]).service("LibraryShapeService",["$rootScope",function(t){this.show=function(e){t.$broadcast("show-library-"+e)},this.hide=function(e){t.$broadcast("hide-library-"+e)}}]).service("ImageProxyService",function(){var n={proxy:'<img class="img-proxy">',installed:!1,pelem:null},o={proxy:'<div class="shape-proxy"></div>',installed:!1,pelem:null},r={proxy:'<div class="slide-proxy"></div>',installed:!1,pelem:null};this.getProxy=function(e){var t=o;return"img"==e?t=n:"slide"===e&&(t=r),t.installed||((e=t).pelem=angular.element(e.proxy),angular.element("body").append(e.pelem),e.installed=!0),t.pelem}}).service("NotifyService",["$timeout",function(t){var n={visible:!1,msg:""};this.getInfoState=function(){return n},this.info=function(e){n.visible||t(function(){n.visible=!1},14e3),n.visible=!0,n.msg=e},cancelStream.onValue(function(){n.visible=!1})}]).service("IntegrationsService",function(){this.selectAccount=function(e){var t=_.find(e,function(e){return 1==e.defaultAccount});return t=!t&&0<e.length?e[0]:t}}).service("AccountService",["accountType",function(t){this.timeLeft=function(e){return 1==e.daysLeft?e.daysLeft+" day":e.daysLeft+" days"},this.isActiveBusinessAccount=function(e){return e.accountType===t.business&&0<e.daysLeft};var n=null;this.selectPlan=function(e,t){n={plan_id:e,interval_id:t}},this.selectedPlanAndReset=function(){var e=n;return n=null,e},this.monthly={id:"month",name:"Monthly Billing",unit:"monthly"},this.yearly={id:"year",name:"Yearly Billing",unit:"yearly"};var o=[this.monthly,this.yearly];this.periodIntervals=o,this.findIntervalByIntervalId=function(t){var e=_.filter(o,function(e){return e.id==t});return e&&0<e.length?e[0]:null}}]).service("BoardManagerService",["$rootScope","PopoverService","AuthService",function(e,t,n){var o=n.currentBoard;e.$watch(n.currentBoard,function(e){o=e}),this.getBoardsInfo=function(e,t,n){return getBoardInfo(e,t,n)},this.currentBoard=function(){return o},this.showChangeBoardName=function(){t.closeAllOpenPopovers(),showChangeBoardName(n.currentBoard().boardId)},this.changeBoardName=function(e){changeBoardName(this.currentBoard().boardId,e)},this.boardNameOrEmpty=function(){var e=this.currentBoard().name;return e=e===this.currentBoard().boardId?"":e}}]).service("PopoverService",["$q","$templateCache","$http","$compile","$timeout","Helpers",function(i,c,l,s,u,d){var a=this;this.isMenuOpen=function(){var e=!1;return $(".popover.in").each(function(){e=!0}),e},this.closeAllOpenPopovers=function(){$(".popover.in[data-launcher]").each(function(){var e=$(this).attr("data-launcher").split(":");"string"==typeof e?$(e).popover("hide"):$(e[0]).popover("hide",e[1])}),$(".tooltip.in").each(function(){$(this).hide()})},this.participateCloseAllOpenPopover=function(e){e.on("mousedown",function(){a.closeAllOpenPopovers()})},this.popoverTitle=function(e,t,n){return n?d.format('<strong>{}</strong><button type="button" class="close" onclick="$(&quot;{}&quot;).popover(&quot;hide&quot;,&quot;{}&quot;);">&times;</button>',e,t,n):d.format('<strong>{}</strong><button type="button" class="close" onclick="$(&quot;{}&quot;).popover(&quot;hide&quot;);">&times;</button>',e,t)},this.popoverTemplate=function(e,t){return d.format('<div class="popover {}" data-launcher="{}"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',e,t)},this.popoverConfig=function(e,t,n,o){var r=$(e);o?r.popover({placement:"top",trigger:"manual",html:"true",title:this.popoverTitle(t,e,o),template:this.popoverTemplate(n,e+":"+o)},o):jQuery(e).popover({placement:"top",trigger:"manual",html:"true",title:this.popoverTitle(t,e),template:this.popoverTemplate(n,e)}),a.participateCloseAllOpenPopover(r)},this.popoverShow=function(e,t,n){e=$(e);e.attr("data-content",t),n?e.popover("show",n):e.popover("show")},this.popoverShowAndFocus=function(e,t,n,o){a.popoverShow(e,t,o),$(n).focus()},this.tooltipWithCloseConfig=function(e,t){$selector=jQuery(e),$selector.tooltip({title:t,trigger:"hover"}),$selector.on("mousedown",function(e){$this=$(this),$this.tooltip("hide")})},this.tooltipAndPopoverFullConfig=function(e,t,n){},this.showFormAndFocus=function(e,t,n,o,r,a){i.when(c.get(e)||l.get(e,{cache:!0}).then(function(e){angular.isObject(e.data)&&(e=t.attr("data-content",e.data.data).data("popover"),t.popover("show"),$(n).focus(),a(e),s(o)(r))}))},this.showFormAndFocus2=function(e,t,n,o,r,a){e=d.format("<div id='{}' ng-include src='\"{}\"'></div>",o,e),e=t.attr("data-content",e).data("popover");t.popover("show"),a(e),s("#"+o)(r),u(function(){$(n).focus()},100)}}]),angular.module("myApp.filters",[]).filter("formatUserRole",["$sce",function(t){return function(e){switch(e){case 0:return t.trustAsHtml('<span class="label label-rw account-member">member</span>');case 1:return t.trustAsHtml('<span class="label label-po">primary owner</span>');case 2:return t.trustAsHtml('<span class="label label-ro">read-only member</span>');case 3:return t.trustAsHtml('<span class="label label-admin">admin</span>');default:return""}}}]).filter("formatAccepted",["$sce",function(e){return function(e){return!(0<e)&&0==e?'<span class="label label-warning" style="margin-left: 5px;" title="Team member has been invited, but has not joined the team yet">invited</span>':""}}]).filter("formatDefaultAccount",["$sce",function(t){return function(e){return!0!==e?"":t.trustAsHtml('<span class="label" style="margin-left: 5px;">Default Team</span>')}}]).filter("formatFreePlan",function(){return function(e){return"<span class='label'>Free Plan</span>"}}).filter("formatAccountType",["Helpers","$sce",function(n,e){return function(t){return e.trustAsHtml(function(){var e='<span class="label {}">{}</span>';switch(t){case 0:return n.format(e,"","Free");case 1:return n.format(e,"label-warning","Trial");case 2:return n.format(e,"","Business Team");case 3:return n.format(e,"","Team");case 4:return n.format(e,"","Unit");case 5:return n.format(e,"","Department");case 6:return n.format(e,"","Division");default:return""}}())}}]).filter("formatPlan",["Helpers","$sce",function(t,n){return function(e){return n.trustAsHtml(t.format('<span class="label {}">Plan {}</span>',"",e))}}]).filter("formatAccountPlan",function(){return function(e){return void 0!==e.plan||e.expired?void 0===e.plan&&e.expired?"Free":void 0!==e.plan&&e.expired?e.plan.name+" - Expired":void 0!==e.plan?e.plan.name:"":"Trial"}}).filter("formatVisibility",["Helpers","$sce",function(n,e){return function(t){return e.trustAsHtml(function(){var e='<span class="green-highlight" title="{}">{}</span>';switch(t){case 0:return n.format(e,"Only you can see the board, click to publish.","Private");case 1:return n.format(e,"Team members can open the board who have the URL","Team Members With URL");case 2:return n.format(e,"Team members can see board listed and open the board","Team");default:return""}}())}}]).filter("formatBoardVisibility",[function(){return function(e){var t="";return e.isFree()?t="Public board":!e.isFree()&&e.isPrivate()?t="Private board":e.isFree()||e.isPrivate()||(t="Team board"),t}}]).filter("formatUserName",["Helpers",function(t){return function(e){return""===e.firstName&&""===e.lastName?t.capitalize(e.email):e.displayName+" – "+e.firstName+" "+e.lastName}}]).filter("capitalLetters",function(){return function(e,t){var n="";return e&&0<e.length&&1==(n=_.map(_.first(e.split(" "),t),function(e){return e.substring(0,1).toUpperCase()}).join("")).length&&2<=e.length&&(n+=e[1]),n}}).filter("resolved",function(){return function(e){switch(e){case 0:return"Open";case 1:return"Done"}return"Open"}}).filter("checked",["$sce",function(t){return function(e){switch(e){case 0:return"";case 1:return t.trustAsHtml("&#x2713;")}return""}}]).filter("capitalize",["Helpers",function(n){return function(e,t){return n.capitalize(e)}}]).filter("apiMessage",["apimsg",function(t){return function(e){switch(e){case"1":return t.insufficienPlan;case"2":return t.notAdmin;default:return"Sorry, unexpected error."}}}]).filter("formatMates",function(){return function(e){for(var t=_.map(e,function(e){return e.email}),n="",o=0;o<t.length;++o)o==t.length-1&&1<t.length?n+=" and ":0<o&&(n+=", "),n+=t[o];return n}}).filter("boardName",function(){return function(e){return""==e.boardName?e.boardId:e.boardName}}).filter("tagName",function(){return function(e){return 1<e.boardCount?e.name+" ("+e.boardCount+")":e.name}}).filter("simplifyDate",["$filter",function(i){return function(e,t){var n=new Date,o=new Date;function r(e,t){return e.getMonth()===t.getMonth()&&e.getFullYear()===t.getFullYear()&&e.getDate()===t.getDate()}o.setDate(o.getDate()-1);var a=new Date(e);return r(a,n)?i("date")(e,"HH:mm")+" today":r(a,o)?i("date")(e,"HH:mm")+" yesterday":i("date")(e,"HH:mm MMM d, y")}}]).filter("createdBy",function(){return function(e){return e.uname||e.email}}).filter("statusMessage",[function(){return function(e){var t="";return e.opts&&e.opts&&(2==(2&e.opts)?t="Marked as resolved":4==(4&e.opts)&&(t="Re-opened")),e.uat!==e.cat&&(0===t.length?t+="edited":t+=", edited"),t}}]).filter("shortcut",["Helpers",function(o){return function(e,t){var n="";return e=e||n,n=o.isMac()?e+" | ⌘"+t:e+" | Ctrl+"+t}}]).filter("shortcut2",["Helpers",function(o){return function(e,t){var n="";return e=e||n,n=o.isMac()?e+"⌘"+t:e+"Ctrl+"+t}}]),angular.module("myApp.constants",[]).value("anonymous","anonymous").value("elementType",{comment:"comment",commentThread:"comments"}).value("accountType",{free:0,trial:1,business:2}).value("contextMenuFillColor","#efefef"),angular.module("myApp.factories").factory("ShapeInfo",function(){function e(){}return e.prototype.getElementType=function(){return this.target_type||this.et},e}),angular.module("myApp.services").service("ShapeService",["contextMenuFillColor",function(i){function c(e){for(var t=e.split(";"),n={},o=0;o<t.length;++o){var r=t[o].split(":");r&&2==r.length&&(n[r[0]]=r[1])}return n}function l(e,t,n){var o=gwtThemeColors();t=t||o.border_color,n&&n.c&&n.c.dboc&&(t=n.c.dboc);return(e=function(e,t){t&&e&&t.c&&t.c.dbc&&(e.includes("fill:")?e=e.replace("fill:shape-bgcolor;","fill:"+t.c.dbc+";"):(0<e.length&&(e+=";"),e+="fill:"+t.c.dbc+";fill-opacity:1;"));return e}(e=e.replace("fill:bordercolor-dark;","fill:#b3b3b3;fill-opacity:1;").replace("fill:bgcolor-light;","fill:#ececec;fill-opacity:1;").replace("fill:bgcolor-dark;","fill:#cccccc;fill-opacity:1;"),n)).replace("fill:bordercolor;","fill:"+t+";fill-opacity:1;").replace("fill:bgcolor;","fill:#656464;fill-opacity:1;")}this.shapeWidth=function(e,t){var n=e/t.w,e=e/t.h;return parseInt((n<e?n:e)*t.w)},this.shapeHeight=function(e,t){var n=e/t.w,e=e/t.h;return parseInt((n<e?n:e)*t.h)},this.transform=function(e,t,n){var o=e/t.w,t=e/t.h,t=o<t?o:t;return"matrix("+t+" 0 0 "+t+" 0 0)"},this.transformCenter=function(e,t,n,o){var r=t/n.w,t=t/n.h,t=r<t?r:t;return"matrix("+t+" 0 0 "+t+" "+Math.abs(e-n.w*t)/2+" "+Math.abs(e-n.h*t)/2+")"},this.shapeStyle=function(e,t,n){if(e.sl&&0<e.sl.length){var o=c(l(e.s,t,n)),r=c(e.sl);return a=t,(r=r).hasOwnProperty("fill")&&i===a&&(r.fill="#000000"),function(e){var t,n="";for(t in e)e.hasOwnProperty(t)&&(0<n.length&&(n+=";"),n+=t+":"+e[t]);return n}(function(e,t){for(var n in t)e[n]=t[n];return e}(o,r))}var a;return l(e.s,t,n)},this.saveBoardShape=function(e,t){var n,o;gwtIsShapeCached(e.getElementType())?t(e):(n=e,o=function(e){gwtShapeCacheAdd(e),t(e)},e="tutorial",currentBoard()&&(e=currentBoard().boardId),"undefined"!=typeof libraryService&&libraryService.saveBoardShape({board_id:e,element_type:n.et,shape_type:tsCurrentSketchMode()}).then(function(e){0==e.ok?o(n):globalStreams.notifyStream.push("Sorry, failed to add shape. Please contact support@sketchboard.io.")}))}}]).service("ShapeConfService",[function(){this.order=["noteitem","actoritem","usecase","classitem","sequenceitem","server","comp","storage","textitem","comments","astart","activity","choice","hfork","vfork","aend","centtop","maintopic","subtopic","package","star4","star5","envelope","triangle","bubble-l","bubble-r","rect","lightbulb","circle","smiley","polygon4","polygon8","arrow-up","arrow-d","arrow-r","arrow-l","cloud","firewall","switch","router","w-browser","desktop","laptop","server2","iphone","android","phone","tablet_u","tablet_h"],this.details={noteitem:{short:"Note",c:{dt:"**Markdown** _note_"}},classitem:{short:"Class",c:{dt:"Class"}},actoritem:{c:{dt:"User"}},sequenceitem:{short:"Sequence",tdy:-18,c:{dt:"Sequence"}},storage:{short:"Db",tdy:-2,c:{dt:"Db"}},textitem:{short:"Markdown<br><i>text</i>",tdy:-15,c:{dt:"**Markdown** _text_"}},"bubble-l":{short:"Markdown<br><i>bubble</i>",tdy:-15,c:{dt:"**Markdown** _bubble_"}},"bubble-r":{short:"Markdown<br><i>bubble</i>",tdy:-15,c:{dt:"**Markdown** _bubble_"}},astart:{short:"Start<br>flow",tdy:-15},comp:{short:"Comp",c:{dt:"Component"}},usecase:{short:"Use case",c:{dt:"Use Case"}},package:{short:"Package",c:{dt:"Package"}},rect:{short:"Rect"},circle:{short:"Circle"},vpart:{target_type:"rectcont",c:{tw:170,th:225}},activity:{short:"Activity",c:{dt:"Activity"}},centtop:{short:"Central<br>topic",tdy:-15,c:{dt:"Central Topic"}},maintopic:{short:"Main topic",target_type:"activity",c:{dt:"Main Topic"}},subtopic:{short:"Sub topic",target_type:"textitem",c:{dt:"Sub topic"}},comments:{short:"Comments"},server2:{c:{tw:43,th:86}},firewall:{c:{tw:74,th:139}}}}]),window.appInjector=function(){return angular.element("html").injector()},window.popoverConfig=function(e,t,n,o){setTimeout(function(){appInjector().get("PopoverService").popoverConfig(e,t,n,o)},500)},window.popoverShow=function(e,t,n){appInjector().get("PopoverService").popoverShow(e,t,n)},window.popoverShowAndFocus=function(e,t,n,o){appInjector().get("PopoverService").popoverShowAndFocus(e,t,n,o)},window.closeAllPopovers=function(){appInjector().get("PopoverService").closeAllOpenPopovers()},$.cachedScript=function(e,t){return t=$.extend(t||{},{dataType:"script",cache:!0,url:e}),jQuery.ajax(t)},$.cachedCss=function(e,t){return t=$.extend(t||{},{dataType:"text",cache:!0,url:e}),jQuery.ajax(t)};var uiutils=function(){var e,t={};return t.getPosition=function(e){var t=e[0];return $.extend({},"function"==typeof t.getBoundingClientRect?t.getBoundingClientRect():{width:t.offsetWidth,height:t.offsetHeight},e.offset())},t.applyPos=function(e,t,n,o){o.css({top:e.top+n+"px",left:e.left+t+"px"})},t.mobile=(e=window.navigator.userAgent,/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile/i.test(e)),t.isMobile=function(){return t.mobile},t}(),bigcssloader=function(){var t=[];"undefined"!=typeof _config&&t.push(_config.staticPrefix+"/resources-static-1/css/font-awesome/4.5.0/css/font-awesome.min.css");function e(){for(var e=0;e<t.length;++e)!function(e){var t=document.createElement("link");t.rel="stylesheet",t.href=e;e=document.getElementsByTagName("head")[0];e.parentNode.insertBefore(t,e)}(t[e])}var n=requestAnimationFrame||mozRequestAnimationFrame||webkitRequestAnimationFrame||msRequestAnimationFrame;n?n(e):window.addEventListener("load",e)}(),SketchboardClipboard=new(function(){$(document).on("paste",function(e){var t=e.originalEvent&&e.originalEvent.clipboardData&&e.originalEvent.clipboardData.items,n={files:[]};t&&t.length&&$.each(t,function(e,t){t=t.getAsFile&&t.getAsFile();t&&n.files.push(t)}),0==n.files&&function(e){var t=(n=e.clipboardData||e.originalEvent&&e.originalEvent.clipboardData)&&n.getData("text/plain");if(t)try{var n,o=JSON.parse(t),r=location.pathname.substring(1);o.boardId&&o.items&&(n={to_board:r,from_board:o.boardId,items:JSON.stringify(o.items)},backendClipboard.pasteFromClipboard2(n).then(function(e){e&&gwtPaste(t)}))}catch(e){}}(e)});return function(){var n;this.value="",$(document).keydown((n=this,function(e){var t;$(e.target).is("input:visible,textarea:visible")||"function"==typeof window.getSelection&&null!=(t=window.getSelection())&&t.toString()||null!=(t=document.selection)&&t.createRange().text||function(t,e){try{if(!e.ctrlKey&&!e.metaKey)return;if(t.value=gwtCopy(),!t.value||"[]"==t.value)return;_.defer(function(){var e=$("#clipboard-container");e.empty().show(),$("<textarea id='clipboard'></textarea>").val(t.value).appendTo(e).focus().select()})}catch(e){}}(n,e)})),$(document).keyup(function(e){if($(e.target).is("#clipboard"))return $("#clipboard-container").empty().hide()})}}());angular.module("texts",[],["$provide",function(e){e.value("sharemenu",{nowpublic:"Board is now public, world viewable.",nowsharedwithaccount:"Board is now shared with {} team.",nowprivate:"Board is now private personal.",rememberSharePassword:"Remember to share password with collaborators.",sharedWithAccount:"Board is shared with your team."}),e.value("boardmenu",{makePrivate:"Board has been associated with {} account and it's visibility is private. Share board to give access within a team.",renameCondition:"You need to be logged in to rename a board.",onlyOwnerCanChangeBoardName:"Only board owner can change board name.",cannotRenameTeamAccountExpired:"Sorry, cannot rename since your default team account is expired. Please subscribe to activate your team account.",restoreTip:"None of your other versions will be lost. This version will be copied and become the current editable board.",freeOwnedSomeoneElse:'This is <strong>public read only</strong> board. You need to be logged in and accepted as collaborator in the team to edit the board. <a href="/service/signup/{}" class="action-text">Sign up</a>.',freeMyBoard:"This is <strong>public board</strong>. Anyone can access the board as read only. Only team members can edit the board.",freeNotOwnedBoard:'<span>This is public board. <a ng-click="markCurrentAsPro()" class="action-text">Make it private.</a></span>',freeNotOwnedBoardNotLoggedIn:'This is a public board. <a href="/service/signup/{}" class="action-text">Sign up and take ownership.</a>'}),e.value("errormsg",{fileTypeNotSupported:"Upload failed. Supported file types are gif, png and jpg.",fileUploadFull:"You cannot upload any more images. Maximum storage space exceeded. Try to upload smaller image or remove images from the library.",tooBigFile:"Maximum file size is 5 MB. Please, try to upload a smaller file.",paymentFailed1:'You already have an active subscription. Please contact <a style="text-decoration: underline;" href="mailto:info@7scales.net">info@7scales.net</a> if needed.'}),e.value("apimsg",{notAdmin:"Non admin tried to add users to the team. Team admin should add team members manually.",insufficienPlan:"Current team plan doesn't support this many members. Team admin should check team members and upgrade team plan to add new collaborators."}),e.value("hipchatint",{enabledText:"Yesh, HipChat Sketchboard.io integration is enabled!",disabledText:"HipChat Sketchboard.io integration is disabled."})}]),function(u){u.fn.markdownify=function(e){var c,l,s;return e&&e.cloudinary&&(c=e.cloudinary.cloudName,l=e.cloudinary.unsignedUploadingKey),this.each(function(){var e=this,r=CodeMirror.fromTextArea(e,{lineWrapping:!0,theme:"default",dragDrop:!1});s=r;var t=u('.btn--preview[data-target="'+e.id+'"]'),n=t.text()||"Preview";t.data("toggle-text");function o(e,t){r.replaceSelection(e+r.getSelection()),t&&r.replaceSelection(t,"start")}function a(){var e=r.getSelection(),t="type url",n=(t=0===e.indexOf("http://")||0===e.indexOf("https://")||0===e.indexOf("mailto:")?e:t)===e?!1:!0;r.replaceSelection("["+e+"]("+t+")");var o=r.getCursor(),e=_.clone(o);n?(--o.ch,e.ch-=t.length+1):(o.ch-=t.length+3,e.ch-=2*t.length+3),r.setSelection(e,o)}t.text(n);var i={el:function(e){o(e.data("prefix"),e.data("suffix"))},line:function(e){var t=r.getCursor();r.setSelection({line:t.line,ch:0}),r.replaceSelection(e.data("prefix")+" "+r.getSelection());e=r.getLine(t.line);r.setSelection({line:t.line,ch:e.length})},link:function(){a()},video:function(){var e=window.prompt("Enter a video url ex: https://www.youtube.com/watch?v=bGutVrdL3M8");e&&r.replaceSelection("\n"+e+"\n\n")},img:function(e){u("#"+e.parent(".markdownify-menu").data("target")+"-upload_field").trigger("click")}};r.setOption("extraKeys",{Tab:function(e){var t=Array(5).join(" ");e.replaceSelection(t)},"Cmd-B":function(e){o("**","**")},"Ctrl-B":function(e){o("**","**")},"Cmd-I":function(e){o("_","_")},"Ctrl-I":function(e){o("_","_")},"Cmd-L":function(e){a()},"Ctrl-L":function(e){a()}}),u(e.parentNode).find('.markdownify-menu[data-target="'+e.id+'"] .btn--insert').click(function(e){i[u(this).data("type")||"el"](u(this)),r.focus(),e.preventDefault()}),c&&(u("body").append("          <form enctype='multipart/form-data'>            <input class='upload_field' data-target='"+e.id+"' id='"+e.id+"-upload_field' name='file' type='file'/>          </form>        "),u(".upload_field[data-target="+e.id+"]").unsigned_cloudinary_upload(l,{cloud_name:c,tags:"browser_uploads"},{multiple:!0}).bind("cloudinarydone",function(e,t){r.replaceSelection("![]("+u.cloudinary.url(t.result.public_id,{cloud_name:c})+")\n"),r.focus()}))}),s}}(jQuery);